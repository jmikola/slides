<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Real-time Aggregation with MongoDB</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.min.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/github.css">
        <link rel="stylesheet" href="../vendor/reveal.js/css/theme/sky.css">
        <link rel="stylesheet" href="css/main.css">

        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '../vendor/reveal.js/css/print/pdf.css';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        </script>

        <!--[if lt IE 9]>
        <script src="../vendor/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section data-state="title">
                    <h1>Real-time Data Aggregation <small>with</small><br><span class="logo-mongodb"></span></h1>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">@jmikola</a></p>
                </section>

                <section>
                    <h2>Agenda</h2>

                    <img src="img/dilbert-20120905.gif" alt="dilbert-20120905.gif" width="80%" class="transparent">

                    <div class="col-left">
                        <ul>
                            <li>Available Tools</li>
                            <li>Schemas</li>
                            <li>Commands</li>
                            <li>MapReduce</li>
                        </ul>
                    </div>

                    <div class="col-right">
                        <ul>
                            <li>Aggregation Framework</li>
                            <li>Pipeline, Expressions</li>
                            <li>Usage, Sharding</li>
                            <li>Looking Ahead</li>
                        </ul>
                    </div>
                </section>

                <section data-state="intro">
                    <h2>Setting the Stage</h2>

                    <p>We have data stored in MongoDB.</p>

                    <p>We need to do ad-hoc reporting,<br>grouping, common aggregations, etc.</p>

                    <p>What can we use for this?</p>
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ## Data Warehousing

                        * SQL for reporting and analytics
                        * Infrastructure complications
                            * Additional maintenance
                            * Data duplication
                            * ETL processes
                            * Real time?
                    </script>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Schema-based

                            * Documents hold pre-aggregated data
                            * Processing at time of insert/update
                            * Optimized for real-time queries
                            * In-place updates avoid fragmentation
                            * [MongoDB for Analytics](https://speakerdeck.com/jnunemaker/mongodb-for-analytics-3) by [John Nunemaker](http://twitter.com/jnunemaker)
                        </script>
                    </section>

                    <section>
                        <iframe class="speakerdeck-iframe" style="border: 0px; background-color: transparent; margin: 0px; padding: 0px; border-top-left-radius: 5px; border-top-right-radius: 5px; border-bottom-right-radius: 5px; border-bottom-left-radius: 5px; width: 20em; height: 17em; background-position: initial initial; background-repeat: initial initial;" frameborder="0" src="https://speakerdeck.com/player/981aa470220c01305d2612313933acc8?slide=37" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Single-purpose Commands

                            * [count](http://docs.mongodb.org/manual/reference/command/count/)
                            * [distinct](http://docs.mongodb.org/manual/reference/command/distinct/)
                            * [group](http://docs.mongodb.org/manual/reference/command/group/)
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Count

                            ```js
                            db.records.insert({ a: 1, b: 0 });
                            db.records.insert({ a: 1, b: 1 });
                            db.records.insert({ a: 1, b: 4 });
                            db.records.insert({ a: 2, b: 2 });

                            db.records.count(); // Returns 4

                            db.records.count({ a: 1 }); // Returns 3
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Distinct

                            ```js
                            db.orders.insert({ customer: "A123", amount: 500, status: "A" });
                            db.orders.insert({ customer: "A123", amount: 250, status: "A" });
                            db.orders.insert({ customer: "B212", amount: 200, status: "A" });
                            db.orders.insert({ customer: "A123", amount: 300, status: "D" });

                            db.records.distinct("customer"); // Returns ["A123", "B212"]
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <!-- highlight.js defaults to SQL here, so force another language -->
                        <script type="text/template">
                            ### Group

                            ```objectivec
                            db.records.insert({ a: 1, count: 4 });
                            db.records.insert({ a: 1, count: 2 });
                            db.records.insert({ a: 1, count: 4 });
                            db.records.insert({ a: 2, count: 3 });
                            db.records.insert({ a: 2, count: 1 });
                            db.records.insert({ a: 1, count: 5 });
                            db.records.insert({ a: 4, count: 4 });

                            db.records.group({
                                key: { a: 1 },
                                cond: { a: { $lt: 3 } },
                                reduce: function(cur, result) { result.count += cur.count },
                                initial: { count: 0 }
                            });

                            // Returns [ { a: 1, count: 15 }, { a: 2, count: 4 } ]
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## MapReduce

                            * Extremely versatile, powerful
                            * Intended for complex data analysis
                            * Overkill for simple aggregation tasks
                                * Averages
                                * Summation
                                * Grouping
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### MapReduce in MongoDB

                            * Implemented with JavaScript
                            * Convenient, but difficult to debug
                            * [Incremental map-reduce](http://docs.mongodb.org/manual/tutorial/perform-incremental-map-reduce/) for batches
                            * Better concurrency with V8
                        </script>

                        <aside class="notes">
                            Write locks (temp collections) can be avoided with options like inline, jsMode, and nonAtomic
                        </aside>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### MapReduce in Action: [MongoQP](https://github.com/jmikola/mongoqp)

                            * MongoDB includes a [database profiler](http://docs.mongodb.org/manual/tutorial/manage-the-database-profiler/)
                            * Use map-reduce for query log analysis
                            * Parse BSON query objects with JavaScript
                            * Group and aggregate similar queries
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Profile Data

                            ```js
                            {
                              "op" : "query",
                              "ns" : "db.collection",
                              "query" : { … },
                              "ntoreturn" : 0,
                              "ntoskip" : 0,
                              "nscanned" : 11426,
                              "lockStats" : { … },
                              "nreturned" : 0,
                              "responseLength" : 20,
                              "millis" : 12,
                              "ts" : ISODate("2013-05-23T21:24:39.327Z"),
                            }
                            ```
                        </script>
                    </section>

                    <section>
                        <img src="img/mongoqp.png" class="transparent">
                    </section>
                </section>

                <section>
                    <p>And now for something completely different…</p>

                    <img src="img/monty_python.jpg" alt="monty_python.jpg">
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ## Aggregation Framework

                        * Declared with BSON, like queries
                        * Executes in C++, not JavaScript
                        * Flexible, functional, and *simple*
                            * Operation pipeline
                            * Computational expressions
                    </script>
                </section>

                <section>
                    <section>
                        <h1>Pipeline</h1>

                        <br>
                        <div class="mario-container">
                            <div class="mario-bg"></div>
                            <div class="mario-pipes"></div>
                            <div class="mario-sprite"></div>
                        </div>
                    </section>

                    <section data-markdown data-state="pipeline">
                        <script type="text/template">
                            ## Pipeline

                            * Process a stream of documents
                                * Original input is a collection
                                * Final output is a result document
                            * Series of operators
                                * Filter or transform data
                                * Input/output chain

                            ```no-highlight
                            ps ax | grep mongod | head -n 1
                            ```
                        </script>
                    </section>

                    <section>
                        <h2>Pipeline Operators</h2>

                        <div class="col-left">
                            <ul>
                                <li><code>$match</code></li>
                                <li><code>$project</code></li>
                                <li><code>$group</code></li>
                                <li><code>$unwind</code></li>
                            </ul>
                        </div>

                        <div class="col-right">
                            <ul>
                                <li><code>$sort</code></li>
                                <li><code>$limit</code></li>
                                <li><code>$skip</code></li>
                                <li><code>$geoNear</code></li>
                            </ul>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Our Example Data

                            Library Books

                            ```js
                            { _id: 375,
                              title: "The Great Gatsby",
                              ISBN: "9781857150193",
                              available: true,
                              pages: 218,
                              chapters: 9,
                              subjects: [
                                "Long Island",
                                "New York",
                                "1920s"
                              ],
                              language: "English",
                              publisher: {
                                city: "London",
                                name: "Random House"
                              }
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## $match

                            * Filter documents
                            * Uses existing [query syntax](http://docs.mongodb.org/manual/reference/operators/)
                        </script>

                        <aside class="notes">
                            Geospatial operators supported since 2.4.
                            No JavaScript execution via $where.
                        </aside>
                    </section>

                    <section>
                        <h2>$match</h2>

                        <p>Matching field values</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $match: {
  language: "Russian"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$match</h2>

                        <p>Matching with query operators</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $match: {
  pages: { $gt: 1000 }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## $project

                            * Reshape documents
                            * Include, exclude or rename fields
                            * Inject computed fields
                            * Manipulate sub-document fields
                        </script>
                    </section>

                    <section>
                        <h2>$project</h2>

                        <p>Including and excluding fields</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  _id: 0,
  title: 1,
  language: 1
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  language: "English"
}</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$project</h2>

                        <p>Renaming and computing fields</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  avgPagesPerChapter: {
    $divide: [
      "$pages",
      "$chapters"
    ]
  },
  lang: "$language"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: 375,
  avgPagesPerChapter: 24.2222222222,
  lang: "English"
}</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$project</h2>

                        <p>Creating and extracting sub-document fields</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  publisher: {
    city: "London",
    name: "Random House"
  }
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  title: 1,
  stats: {
    pages: "$pages",
    chapters: "$chapters",
  },
  pub_city: "$publisher.city"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  stats: {
    pages: 218,
    language: "English"
  },
  pub_city: "London"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## $group

                            * Group documents by an ID
                                * Field reference, object, constant
                            * Other output fields are computed
                                * `$max`, `$min`, `$avg`, `$sum`
                                * `$addToSet`, `$push`
                                * `$first`, `$last`
                        </script>

                        <aside class="notes">
                            All data is processed in memory.
                        </aside>
                    </section>

                    <section>
                        <h2>$group</h2>

                        <p>Calculating an average</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  avgPages: { $avg: "$pages" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: "Russian",
  avgPages: 1440
}</code></pre>
                            <pre><code class="language-javascript">{ _id: "English",
  avgPages: 653
}</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$group</h2>

                        <p>Summating fields and counting</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  numTitles: { $sum: 1 },
  sumPages: { $sum: "$pages" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: "Russian",
  numTitles: 1,
  sumPages: 1440
}</code></pre>
                            <pre><code class="language-javascript">{ _id: "English",
  numTitles: 2,
  sumPages: 1306
}</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$group</h2>

                        <p>Collecting distinct values</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  titles: { $addToSet: "$title" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: "Russian",
  titles: [ "War and Peace" ]
}</code></pre>
                            <pre><code class="language-javascript">{ _id: "English",
  titles: [
    "Atlas Shrugged",
    "The Great Gatsby"
  ]
}</code></pre>
                        </div>
                    </section>
                </section>
                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## $unwind

                            * Operate on an array field
                            * For each element, yield a document
                            * Pipe to `$group` to aggregate array values
                        </script>
                    </section>

                    <section>
                        <h2>$unwind</h2>

                        <p>Yielding multiple documents from one</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ]
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $unwind: "$subjects" }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: "Long Island"
}</code></pre>
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: "New York"
}</code></pre>
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: "1920s"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## $sort, $limit, $skip

                            * Sort documents by one or more fields
                                * Same order syntax as [cursors](http://docs.mongodb.org/manual/reference/method/cursor.sort/)
                            * Limit and skip follow cursor behavior
                        </script>

                        <aside class="notes">
                            Sort exhausts the previous pipeline operator before emitting anything.
                            Sorts occur in-memory unless they are early in the pipeline and indexed.
                        </aside>
                    </section>

                    <section>
                        <h2>$sort</h2>

                        <p>Sort all documents in the pipeline</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $sort: { title: 1 }}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$limit</h2>

                        <p>Limit documents through the pipeline</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $limit: 5 }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                        </div>
                    </section>

                    <section>
                        <h2>$skip</h2>

                        <p>Skip over documents in the pipeline</p>

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $skip: 2 }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## $geoNear

                            * Only used to start the pipeline
                            * Returns documents near a point, in order
                            * Proxies the [geoNear](http://docs.mongodb.org/manual/reference/command/geoNear/) command
                                * Supports the same options
                                * Adds a `distanceField` option
                        </script>
                    </section>
                </section>

                <section>
                    <section data-state="expressions" data-background="img/mario_beads.jpg" data-background-size="cover" data-background-position="top">
                        <h1 class="outline">Expressions</h1>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Expressions

                            * Return computed values
                            * Used with `$project` and `$group`
                            * Reference fields using `$` (e.g. `"$x"`)
                            * Expressions may be nested
                        </script>
                    </section>

                    <section data-markdown data-state="expressions" class="ul-2col">
                        <script type="text/template">
                            ## Expressions

                            * Logic
                              * `$and`, `$or`, `$not`…
                            * Comparison
                              * `$cmp`, `$eq`, `$gt`…
                            * Arithmetic
                              * `$add`, `$divide`…
                            * String
                              * `$strcasecmp`, `$substr`…
                            * Date
                              * `$year`, `$dayOfMonth`…
                            * Conditional
                              * `$cond`, `$ifNull`…
                          </script>
                    </section>
                </section>

                <section>
                    <section data-background="img/mario_shell.png" data-background-size="14em" data-background-position="right 1em top 35%">
                        <h1>Usage</h1>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Usage

                            * `aggregate` database command
                            * `collection.aggregate()` shell helper
                            * [MongoCollection::aggregate()](http://php.net/manual/en/mongocollection.aggregate.php) in PHP
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Collection Method

                            ```js
                            db.books.aggregate([
                              { $sort: { created: 1 }},
                              { $unwind: "$subjects" },
                              { $group: { _id: "$subjects", n: { $sum: 1 },
                                          fc: { $first: "$created" } }},
                              { $project: { _id: 1, n: 1, fc: { $year: "$fc" }}}
                            ]);
                            ```

                            &#x25BC;

                            ```js
                            {
                              result: [
                                { "_id": "Fantasy", "num": 6, "fc": 2008 },
                                { "_id": "Historical", "num": 7, "fc": 2012 },
                                { "_id": "World Literature", "n": 2, "fc": 2009 }
                                // Other results follow…
                              ],
                              ok: 1
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Database Command

                            ```js
                            db.runCommand({ aggregate: "books", pipeline: [
                              { $sort: { created: 1 }},
                              { $unwind: "$subjects" },
                              { $group: { _id: "$subjects", n: { $sum: 1 },
                                          fc: { $first: "$created" } }},
                              { $project: { _id: 1, n: 1, fc: { $year: "$fc" }}}
                            ]});
                            ```

                            &#x25BC;

                            ```js
                            {
                              result: [
                                { "_id": "Fantasy", "num": 6, "fc": 2008 },
                                { "_id": "Historical", "num": 7, "fc": 2012 },
                                { "_id": "World Literature", "n": 2, "fc": 2009 }
                                // Other results follow…
                              ],
                              ok: 1
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Limitations

                            * Result limited by BSON document size
                                * Final command result
                                * Intermediate shard results
                            * Pipeline operator memory limits
                          </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ### Aggregation Framework in Action

                            * [Time-series visualization](https://github.com/jmikola/silex-mongodb-aggregation-demo)
                            * Stock ticker data
                            * Real-time candlestick charts
                                * Open/close rates per minute
                                * Plot peak points and averages
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Example Data

                            ```js
                            {
                              "_id" : ObjectId("4f4b8916fb1c80e141ea6201"),
                              "ask" : 1.30028,
                              "bid" : 1.3002,
                              "ts" : ISODate("2012-02-16T12:48:00Z")
                            }
                            ```
                        </script>
                    </section>

                    <section>
                        <img src="img/candlestick.png">

                        <p><a href="http://git.io/mongodb-demo">http://git.io/mongodb-demo</a></p>
                    </section>
                </section>

                <section>
                    <section data-background="img/mario_warp_zone.png" data-background-size="cover" data-background-position="center">
                        <h1 class="outline">Sharding</h1>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding

                            * Split the pipeline at first `$group` or `$sort`
                                * Shards execute pipeline up to that point
                                * **mongos** merges results and continues
                            * Early `$match` may excuse shards
                        </script>

                        <aside class="notes">
                            CPU and memory implications for mongos.
                        </aside>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding

                            ```js
                            [
                              { $match:   { /* filter by shard key */ }},
                              { $group:   { /* group by some field */ }},
                              { $sort:    { /* sort by some field  */ }},
                              { $project: { /* reshape result      */ }}
                            ]
                            ```
                        </script>
                    </section>

                    <section data-state="sharding-diagram" style="font-size: 0.8em">
                        <h2>Sharding</h2>

                        <div class="node-3">
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>1</sub></span>
                                    <ul>
                                        <li><code>$match</code></li>
                                        <li><code>$group</code><sub>1</sub></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2198;</span>
                            </div>
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>2</sub></span>
                                    <ul>
                                        <li><code>$match</code></li>
                                        <li><code>$group</code><sub>1</sub></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2193;</span>
                            </div>
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>3</sub></span>
                                </div>
                            </div>
                        </div>

                        <div class="node-1">
                            <div class="node">
                                <span class="label">mongos</span>
                                <ul>
                                    <li><code>$group</code><sub>2</sub></li>
                                    <li><code>$sort</code></li>
                                    <li><code>$project</code></li>
                                </ul>
                            </div>
                            <span class="arrow">&#x2193;</span>
                            <div class="node">
                                <span class="label">Result</span>
                            </div>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-background="img/mario_star.png" data-background-size="20em" data-background-position="right 1em center">
                        <h1 style="text-align: left">Looking Ahead</h1>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Framework Use Cases

                            * Basic aggregation queries
                            * Ad-hoc reporting
                            * Real-time analytics
                            * Visualizing time series data
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Future Enhancements

                            * Coming in MongoDB 2.6
                                * [`$out`](https://jira.mongodb.org/browse/SERVER-3253) operator for output control
                                * [Pipeline explain facility](https://jira.mongodb.org/browse/SERVER-4504)
                            * Down the road
                                * [Optimizing `$match` position](https://jira.mongodb.org/browse/SERVER-4506)
                                * [Grouping sorted input](https://jira.mongodb.org/browse/SERVER-4507)
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Enabling Developers

                            * Doing more within MongoDB, faster
                            * Refactoring MapReduce and groupings
                                * Replace pages of JavaScript
                                * Longer aggregation pipelines
                            * Quick aggregations from the shell
                        </script>
                    </section>

                </section>

                <section data-markdown data-state="final">
                    <script type="text/template">
                        # Thanks!

                        * [Server and drivers](http://www.mongodb.org/downloads)
                        * [Aggregation documentation](http://docs.mongodb.org/manual/aggregation)
                        * [MapReduce query profiler demo app](https://github.com/jmikola/mongoqp)
                        * [Time-series visualization demo app](https://github.com/jmikola/silex-mongodb-aggregation-demo)
                        * [MongoDB shell enhancements for hackers](https://github.com/TylerBrock/mongo-hacker)

                        ### Questions?
                    </script>
                </section>

                <section data-markdown data-state="photo-credits">
                    <script type="text/template">
                        ### Photo Credits

                        * http://dilbert.com/strips/comic/2012-09-05
                        * http://img.timeinc.net/time/photoessays/2009/monty_python/monty_python_02.jpg
                        * http://elevatedscholars.files.wordpress.com/2011/01/dscf0459.jpg
                        * http://purenintendo.com/wp-content/uploads/2009/10/i_20476.jpg
                        * http://i198.photobucket.com/albums/aa77/Stinger1118/Video%20Games/SuperMarioBrosWarpZone.jpg
                        * http://www.blogcdn.com/www.joystiq.com/media/2009/10/marioart102613.jpg
                    </script>
                </section>
            </div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.min.js"></script>
        <script src="../common/js/reveal.js"></script>
    </body>
</html>
