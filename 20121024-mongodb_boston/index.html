<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MongoDB Aggregation Framework</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/github.css">

        <script>
            // If the query includes 'print-pdf' we'll use the PDF print sheet
            document.write('<link rel="stylesheet" href="../vendor/reveal.js/css/print/' + (window.location.search.match(/print-pdf/gi) ? 'pdf' : 'paper') + '.css" type="text/css" media="print">');
        </script>

        <link rel="stylesheet" href="../common/css/theme.10gen.css">
        <link rel="stylesheet" href="css/main.css">

        <!--[if lt IE 9]>
        <script src="../common/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="state-background"></div>

            <div class="slides">
                <section data-state="title">
                    <h1><span class="logo-mongodb">MongoDB</span> Aggregation Framework</h1>

                    <span class="new"></span>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">@jmikola</a></p>
                </section>

                <section data-markdown>
                    ## Agenda

                    <img src="img/dilbert-20120905.gif" alt="dilbert-20120905.gif" style="width: 80%">

                    <div class="col-left">
                        <ul>
                            <li>State of Aggregation</li>
                            <li>Pipeline</li>
                            <li>Expressions</li>
                        </ul>
                    </div>

                    <div class="col-right">
                        <ul>
                            <li>Usage and Limitations</li>
                            <!-- <li>Optimization</li> -->
                            <li>Sharding</li>
                            <!-- <li>Expressions</li> -->
                            <li>Looking Ahead</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <section data-markdown data-state="intro">
                        ## State of Aggregation

                        We're storing our data in MongoDB.

                        We need to do ad-hoc reporting, <br>grouping, common aggregations, etc.

                        What are we using for this?
                    </section>

                    <section data-markdown data-state="warehouse" class="bg">
                        ## Data Warehousing

                        * SQL for reporting and analytics
                        * Infrastructure complications
                            * Additional maintenance
                            * Data duplication
                            * ETL processes
                            * Real time?
                    </section>

                    <section data-markdown data-state="mapreduce" class="bg">
                        ## MapReduce

                        * Extremely versatile, powerful
                        * Intended for complex data analysis
                        * Overkill for simple aggregation tasks
                            * Averages
                            * Summation
                            * Grouping
                    </section>

                    <section data-markdown data-state="mapreduce-mongodb" class="bg">
                        ## MapReduce in MongoDB

                        * Implemented with JavaScript
                            * Single-threaded
                            * Difficult to debug
                        * Concurrency
                            * Appearance of parallelism
                            * Write locks (without `inline` or `jsMode`)
                    </section>

                    <section data-markdown>
                        And now for something completely different…

                        <img src="img/monty_python.jpg" alt="monty_python.jpg">
                    </section>

                    <section data-markdown data-state="framework" class="bg">
                        ## Aggregation Framework

                        * Declared in BSON, executes in C++
                        * Flexible, functional, and *simple*
                            * Operation pipeline
                            * Computational expressions
                        * Plays nice with sharding
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Pipeline

                        <br><div class="mario-bg"><div class="mario-pipes"><div class="mario-sprite"></div></div></div>

<!--
                        * <strike>State of Aggregation</strike>
                        * Pipeline
                        * Expressions
                        * Usage and Limitations
                        <!- - * Optimization - ->
                        * Sharding
                        <!- - * Expressions - ->
                        * Looking Ahead
-->
                    </section>

                    <section data-markdown data-state="pipeline">
                        ## Pipeline

                        * Process a stream of documents
                            * Original input is a collection
                            * Final output is a result document
                        * Series of operators
                            * Filter or transform data
                            * Input/output chain

                        <pre><code class="no-highlight">ps ax | grep mongod | head -n 1</code></pre>
                    </section>

                    <section data-markdown>
                        ## Pipeline Operators

                        * `$match`
                        * `$project`
                        * `$group`
                        * `$unwind`
                        * `$sort`
                        * `$limit`
                        * `$skip`
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## Our Example Data

                        Library Books

                        <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English",
  publisher: {
    city: "London",
    name: "Random House"
  }
}</code></pre>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $match

                        * Filter documents
                        * Uses existing [query syntax](http://docs.mongodb.org/manual/reference/operators/)
                        * No [geospatial operations](http://docs.mongodb.org/manual/reference/operators/#geospatial-query-operators) or `$where`
                    </section>

                    <section data-markdown>
                        ## $match

                        Matching field values

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $match: {
  language: "Russian"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $match

                        Matching with query operators

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $match: {
  pages: { $gt: 1000 }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $project

                        * Reshape documents
                        * Include, exclude or rename fields
                        * Inject computed fields
                        * Manipulate sub-document fields
                    </section>

                    <section data-markdown>
                        ## $project

                        Including and excluding fields

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  _id: 0,
  title: 1,
  language: 1
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  language: "English"
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $project

                        Renaming and computing fields

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  avgPagesPerChapter: {
    $divide: ["$pages", "$chapters"]
  },
  lang: "$language"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: 375,
  avgPagesPerChapter: 24.22222222222222,
  lang: "English"
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $project

                        Creating and extracting sub-document fields

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  ISBN: "9781857150193",
  available: true,
  pages: 218,
  chapters: 9,
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ],
  publisher: {
    city: "London",
    name: "Random House"
  }
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $project: {
  title: 1,
  stats: {
    pages: "$pages",
    chapters: "$chapters",
  },
  pub_city: "$publisher.city"
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  stats: {
    pages: 218,
    language: "English"
  },
  pub_city: "London"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $group

                        * Group documents by an ID
                            * Field reference, object, constant
                        * Other output fields are computed
                            * `$max`, `$min`, `$avg`, `$sum`
                            * `$addToSet`, `$push`
                            * `$first`, `$last`
                        * Processes all data in memory
                    </section>

                    <section data-markdown>
                        ## $group

                        Calculating an average

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  avgPages: { $avg: "$pages" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: "Russian",
  avgPages: 1440
}</code></pre>
                            <pre><code class="language-javascript">{ _id: "English",
  avgPages: 653
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $group

                        Summating fields and counting

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  numTitles: { $sum: 1 },
  sumPages: { $sum: "$pages" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: "Russian",
  numTitles: 1,
  sumPages: 1440
}</code></pre>
                            <pre><code class="language-javascript">{ _id: "English",
  numTitles: 2,
  sumPages: 1306
}</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $group

                        Collecting distinct values

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby",
  pages: 218,
  language: "English"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "War and Peace",
  pages: 1440,
  language: "Russian"
}</code></pre>
                            <pre><code class="language-javascript">{ title: "Atlas Shrugged",
  pages: 1088,
  language: "English"
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $group: {
  _id: "$language",
  titles: { $addToSet: "$title" }
}}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: "Russian",
  titles: [ "War and Peace" ]
}</code></pre>
                            <pre><code class="language-javascript">{ _id: "English",
  titles: [
    "Atlas Shrugged",
    "The Great Gatsby"
  ]
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $unwind

                        * Operate on an array field
                        * Yield new documents for each array element
                            * Array replaced by element value
                            * Missing/empty fields &rarr; no output
                            * Non-array fields &rarr; error
                        * Pipe to `$group` to aggregate array values
                    </section>

                    <section data-markdown>
                        ## $unwind

                        Yielding multiple documents from one

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: [
    "Long Island",
    "New York",
    "1920s"
  ]
}</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $unwind: "$subjects" }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: "Long Island"
}</code></pre>
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: "New York"
}</code></pre>
                            <pre><code class="language-javascript">{ _id: 375,
  title: "The Great Gatsby",
  subjects: "1920s"
}</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        ## $sort, $limit, $skip

                        * Sort documents by one or more fields
                            * Same order syntax as [cursors](http://docs.mongodb.org/manual/reference/method/cursor.sort/)
                            * Waits for earlier pipeline operator to return
                            * In-memory unless early and indexed
                        * Limit and skip follow cursor behavior
                    </section>

                    <section data-markdown>
                        ## $sort

                        Sort all documents in the pipeline

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $sort: { title: 1 }}</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $limit

                        Limit documents through the pipeline

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Lord of the Flies" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Grapes of Wrath" }</code></pre>
                            <pre><code class="language-javascript">{ title: "The Great Gatsby" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $limit: 5 }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                        </div>
                    </section>

                    <section data-markdown>
                        ## $skip

                        Skip over documents in the pipeline

                        <div class="pipeline-step pipeline-in">
                            <pre><code class="language-javascript">{ title: "Animal Farm" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Brave New World" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                        </div>

                        <div class="pipeline-step pipeline-op">
                            <span class="arrow">&#x25BA;</span>
                            <pre><code class="language-javascript">{ $skip: 2 }</code></pre>
                            <span class="arrow">&#x25BC;</span>
                        </div>

                        <div class="pipeline-step pipeline-out">
                            <pre><code class="language-javascript">{ title: "Fahrenheit 451" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Fathers and Sons" }</code></pre>
                            <pre><code class="language-javascript">{ title: "Invisible Man" }</code></pre>
                        </div>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Expressions

                        * <strike>State of Aggregation</strike>
                        * <strike>Pipeline</strike>
                        * Expressions
                        * Usage and Limitations
                        <!-- * Optimization -->
                        * Sharding
                        <!-- * Expressions -->
                        * Looking Ahead
                    </section>

                    <section data-markdown>
                        ## Expressions

                        * Return computed values
                        * Used with `$project` and `$group`
                        * Reference fields using `$` (e.g. `"$x"`)
                        * Expressions may be nested
                    </section>

                    <section data-markdown data-state="expressions" class="ul-2col">
                        ## Expressions

                        * Logic
                          * `$and`, `$or`, `$not`…
                        * Comparison
                          * `$cmp`, `$eq`, `$gt`…
                        * Arithmetic
                          * `$add`, `$divide`…
                        * String
                          * `$strcasecmp`, `$substr`…
                        * Date
                          * `$year`, `$dayOfMonth`…
                        * Conditional
                          * `$cond`, `$ifNull`…
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        # Usage

                        * <strike>State of Aggregation</strike>
                        * <strike>Pipeline</strike>
                        * <strike>Expressions</strike>
                        * Usage and Limitations
                        <!-- * Optimization -->
                        * Sharding
                        <!-- * Expressions -->
                        * Looking Ahead
                    </section>

                    <section data-markdown>
                        ## Usage

                        * `aggregate` database command
                        * `collection.aggregate()` method
                            * Mongo shell
                            * Most drivers
                    </section>

                    <section data-markdown>
                        ## Collection Method

                        <pre><code class="language-javascript">db.books.aggregate([
  { $sort: { created: 1 }},
  { $unwind: "$subjects" },
  { $group: { _id: "$subjects", n: { $sum: 1 },
              fc: { $first: "$created" } }},
  { $project: { _id: 1, n: 1, fc: { $year: "$fc" }}}
]);</code></pre>

                        &#x25BC;

                        <pre><code class="language-javascript">{
  result: [
    { "_id": "Fantasy", "num": 6, "fc": 2008 },
    { "_id": "Historical", "num": 7, "fc": 2012 },
    { "_id": "World Literature", "n": 2, "fc": 2009 }
    // Other results follow…
  ],
  ok: 1
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## Database Command

                        <pre><code class="language-javascript">db.runCommand({ aggregate: "books", pipeline: [
  { $sort: { created: 1 }},
  { $unwind: "$subjects" },
  { $group: { _id: "$subjects", n: { $sum: 1 },
              fc: { $first: "$created" } }},
  { $project: { _id: 1, n: 1, fc: { $year: "$fc" }}}
]});</code></pre>

                        &#x25BC;

                        <pre><code class="language-javascript">{
  result: [
    { "_id": "Fantasy", "num": 6, "fc": 2008 },
    { "_id": "Historical", "num": 7, "fc": 2012 },
    { "_id": "World Literature", "n": 2, "fc": 2009 }
    // Other results follow…
  ],
  ok: 1
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## Limitations

                        * Result limited by BSON document size
                            * Final command result
                            * Intermediate shard results
                        * Pipeline operator memory limits
                        * Some BSON types unsupported
                            * Binary, Code, deprecated types
                    </section>
                </section>
<!--
                <section>
                    <section data-markdown>
                        # Optimization

                        * <strike>State of Aggregation</strike>
                        * <strike>Pipeline</strike>
                        * <strike>Expressions</strike>
                        * <strike>Usage and Limitations</strike>
                        * Optimization
                        * Sharding
                        <!- - * Expressions - ->
                        * Looking Ahead
                    </section>

                    <section data-markdown>
                        ## Optimization

                        * Be mindful of memory usage
                        * Conservative projections
                        * Early matching
                    </section>

                    <section data-markdown>
                        ## Early Matching

                        <pre><code class="language-javascript">[
  { $match:   { /* match criteria          */ }},
  { $sort:    { /* sort matched documents  */ }},
  { $limit:   { /* limit document stream   */ }},
  { $group:   { /* group by a field        */ }},
  { $sort:    { /* sort by aggregate value */ }},
  { $project: { /* reshape result          */ }}
]</code></pre>
                    </section>

                    <section data-markdown>
                        ## Early Matching

                        <pre><code class="language-javascript">db.collection
  .find({ /* match criteria         */ })
  .sort({ /* sort matched documents */ })
  .limit( /* limit document stream  */  )</code></pre>

                        &#x25BC;

                        <pre><code class="language-javascript">[
  { $group:   { /* group by a field        */ }},
  { $sort:    { /* sort by aggregate value */ }},
  { $project: { /* reshape result          */ }}
]</code></pre>
                    </section>
                </section>
-->
                <section>
                    <section data-markdown>
                        # Sharding

                        * <strike>State of Aggregation</strike>
                        * <strike>Pipeline</strike>
                        * <strike>Expressions</strike>
                        * <strike>Usage and Limitations</strike>
                        <!-- * <strike>Optimization</strike> -->
                        * Sharding
                        <!-- * Expressions -->
                        * Looking Ahead
                    </section>

                    <section data-markdown>
                        ## Sharding

                        * Split the pipeline at first `$group` or `$sort`
                            * Shards execute pipeline up to that point
                            * **mongos** merges results and continues
                        * Early `$match` may excuse shards
                        * CPU and memory implications for **mongos**
                    </section>

                    <section data-markdown>
                        ## Sharding

                        <pre><code class="language-javascript">[
  { $match:   { /* filter by shard key */ }},
  { $group:   { /* group by some field */ }},
  { $sort:    { /* sort by some field  */ }},
  { $project: { /* reshape result      */ }}
]</code></pre>
                    </section>

                    <section data-markdown data-state="sharding-diagram">
                        ## Sharding

                        <div class="node-3">
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>1</sub></span>
                                    <ul>
                                        <li><code>$match</code></li>
                                        <li><code>$group</code><sub>1</sub></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2198;</span>
                            </div>
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>2</sub></span>
                                    <ul>
                                        <li><code>$match</code></li>
                                        <li><code>$group</code><sub>1</sub></li>
                                    </ul>
                                </div>
                                <span class="arrow">&#x2193;</span>
                            </div>
                            <div>
                                <div class="node">
                                    <span class="label">shard<sub>3</sub></span>
                                    <!-- <ul>
                                        <li><code>$match</code></li>
                                        <li><code>$group</code><sub>1</sub></li>
                                    </ul> -->
                                </div>
                                <!-- <span class="arrow">&#x2199;</span> -->
                            </div>
                        </div>

                        <div class="node-1">
                            <div class="node">
                                <span class="label">mongos</span>
                                <ul>
                                    <li><code>$group</code><sub>2</sub></li>
                                    <li><code>$sort</code></li>
                                    <li><code>$project</code></li>
                                </ul>
                            </div>
                            <span class="arrow">&#x2193;</span>
                            <div class="node">
                                <span class="label">Result</span>
                            </div>
                        </div>
                    </section>
                </section>
<!--
                <section>
                    <section data-markdown>
                        # Expressions
                    </section>

                    <section data-markdown>
                        ## Expressions

                        * Return computed values
                        * Used with `$project` and `$group`
                        * Reference fields using `$` (e.g. `"$x"`)
                        * Expressions may be nested
                    </section>

                    <section data-markdown>
                        ## Boolean Operators

                        * Input array of one or more values
                            * `$and`, `$or`
                            * Short-circuit logic
                        * Invert values with `$not`
                        * Evaluation of non-boolean types
                            * `null`, `undefined`, zero &rarr; `false`
                            * Non-zero, strings, dates, objects &rarr; `true`

                        <pre><code class="language-javascript">{ $and: [true, false] } &#x25BA; false
{ $or:  ["foo", 0]    } &#x25BA; true
{ $not: null          } &#x25BA; true
</code></pre>
                    </section>

                    <section data-markdown data-state="comparison-operators">
                        ## Comparison Operators

                        * Compare numbers, strings, and dates
                        * Input array with two operands
                            * `$cmp`, `$eq`, `$ne`
                            * `$gt`, `$gte`, `$lt`, `$lte`

                        <pre><code class="language-javascript">{ $cmp: [3, 4]         } &#x25BA; -1
{ $eq:  ["foo", "bar"] } &#x25BA; false
{ $ne:  ["foo", "bar"] } &#x25BA; true
{ $gt:  [9, 7]         } &#x25BA; true
</code></pre>
                    </section>

                    <section data-markdown>
                        ## Arithmetic Operators

                        * Input array of one or more numbers
                            * `$add`, `$multiply`
                        * Input array of two operands
                            * `$subtract`, `$divide`, `$mod`

                        <pre><code class="language-javascript">{ $add:      [1, 2, 3] } &#x25BA; 6
{ $multiply: [2, 2, 2] } &#x25BA; 8
{ $subtract: [10, 7]   } &#x25BA; 3
{ $divide:   [10, 2]   } &#x25BA; 5
{ $mod:      [8, 3]    } &#x25BA; 2
</code></pre>
                    </section>

                    <section data-markdown>
                        ## String Operators

                        * `$strcasecmp` case-insensitive comparison
                            * `$cmp` is case-sensitive
                        * `$toLower` and `$toUpper` case change
                        * `$substr` for sub-string extraction
                        * Not encoding aware (assumes Latin alphabet)

                        <!- -
                            Note: highlight.js picks up "case" in "$strcasecmp"
                            as a keyword. A zero-width space is used to prevent
                            it from matching.
                        - ->
                        <pre><code class="language-javascript">{ $strca&#8203;secmp: ["foo", "bar"] } &#x25BA; 1
{ $substr:     ["foo", 1, 2]  } &#x25BA; "oo"
{ $toUpper:    "foo"          } &#x25BA; "FOO"
{ $toLower:    "BAR"          } &#x25BA; "bar"
</code></pre>
                    </section>

                    <section data-markdown>
                        ## Date Operators

                        * Extract values from date objects
                            * `$dayOfYear`, `$dayOfMonth`, `$dayOfWeek`
                            * `$year`, `$month`, `$week`
                            * `$hour`, `$minute`, `$second`

                        <pre><code class="language-javascript">{ $year:       ISODate("2012-10-24T00:00:00.000Z") } &#x25BA; 2012
{ $month:      ISODate("2012-10-24T00:00:00.000Z") } &#x25BA; 10
{ $dayOfMonth: ISODate("2012-10-24T00:00:00.000Z") } &#x25BA; 24
{ $dayOfWeek:  ISODate("2012-10-24T00:00:00.000Z") } &#x25BA; 4
{ $dayOfYear:  ISODate("2012-10-24T00:00:00.000Z") } &#x25BA; 299
{ $week:       ISODate("2012-10-24T00:00:00.000Z") } &#x25BA; 43
</code></pre>
                    </section>

                    <section data-markdown>
                        ## Conditional Operators

                        * `$cond` ternary operator
                        * `$ifNull`

                        <pre><code class="language-javascript">{ $cond: [{ $eq: [1, 2] }, "same", "different"] } &#x25BA; "different"

{ $ifNull: ["foo", "bar"] } &#x25BA; "foo"
{ $ifNull: [null, "bar"]  } &#x25BA; "bar"
</code></pre>
                    </section>
                </section>
-->
                <section>
                    <section data-markdown>
                        # Looking Ahead

                        * <strike>State of Aggregation</strike>
                        * <strike>Pipeline</strike>
                        * <strike>Expressions</strike>
                        * <strike>Usage and Limitations</strike>
                        <!-- * <strike>Optimization</strike> -->
                        * <strike>Sharding</strike>
                        <!-- * <strike>Expressions</strike> -->
                        * Looking Ahead
                    </section>

                    <section data-markdown>
                        ## Framework Use Cases

                        * Basic aggregation queries
                        * Ad-hoc reporting
                        * Real-time analytics
                        * Visualizing time series data
                    </section>

                    <section data-markdown>
                        ## Extending the Framework

                        * Adding new pipeline operators, expressions
                        * `$out` and `$tee` for output control
                            * [https://jira.mongodb.org/browse/SERVER-3253](https://jira.mongodb.org/browse/SERVER-3253)
                    </section>

                    <section data-markdown>
                        ## Future Enhancements

                        * [Move `$match` earlier when possible](https://jira.mongodb.org/browse/SERVER-4506)
                        * [Pipeline explain facility](https://jira.mongodb.org/browse/SERVER-4504)
                        * Memory usage improvements
                            * [Grouping input sorted by `_id`](https://jira.mongodb.org/browse/SERVER-4507)
                            * [Sorting with limited output](https://jira.mongodb.org/browse/SERVER-4656) ([top *k*](http://en.wikipedia.org/wiki/Partial_sorting#Selecting_k_smallest_or_largest_elements))
                    </section>

                    <section data-markdown>
                        ## Enabling Developers

                        * Doing more within MongoDB, faster
                        * Refactoring MapReduce and groupings
                            * Replace pages of JavaScript
                            * Longer aggregation pipelines
                        * Quick aggregations from the shell
                    </section>
<!--
                    <section data-markdown>
                        ## Shell Enhancements

                        Create helper functions for common tasks

                        <pre><code class="language-javascript">&gt; db.books.gavg("language", "pages")
{ "result": [
    { "_id": "Spanish", "avg": 628 },
    { "_id": "French", "avg": 332.2 },
    { "_id": "English", "avg": 332.96666666666664 }
  ],
  "ok": 1
}

&gt; db.books.gsum("language", "pages")
{ "result": [
    { "_id": "Spanish", "sum": 1256 },
    { "_id": "French", "sum": 1661 },
    { "_id": "English", "sum": 9989 }
  ],
  "ok": 1
}</code></pre>
                    </section>

                    <section data-markdown>
                        ## Shell Enhancements

                        <pre><code class="language-javascript">&gt; db.books.gcount("language")
{ "result": [
    { "_id": "Spanish", "count": 2 },
    { "_id": "French", "count": 5 },
    { "_id": "English", "count": 30 }
  ],
  "ok": 1
}

&gt; db.books.gcount("language", { available: true })
{ "result": [
    { "_id": "Spanish", "count": 1 },
    { "_id": "French", "count": 4 },
    { "_id": "English", "count": 24 }
  ],
  "ok": 1
}</code></pre>
                    </section>
-->
                </section>

                <section data-markdown data-state="final">
                    # Thanks!

                    * [mongodb.org/downloads](http://www.mongodb.org/downloads)
                    * [docs.mongodb.org/manual/aggregation](http://docs.mongodb.org/manual/aggregation)
                    * [github.com/TylerBrock/mongo-hacker](https://github.com/TylerBrock/mongo-hacker)
                    * [github.com/rozza/demos](https://github.com/rozza/demos)

                    ### Questions?
                </section>

                <section data-state="photo-credits">
                    <h3>Photo Credits</h3>

                    <ul>
                        <li><a href="http://dilbert.com/strips/comic/2012-09-05">http://dilbert.com/strips/comic/2012-09-05</a></li>
                        <li><a href="http://www.flickr.com/photos/toolstop/4324416999">http://www.flickr.com/photos/toolstop/4324416999</a></li>
                        <li><a href="http://www.ristart.ee/web2/files/Product/large/13443203307.jpg">http://www.ristart.ee/web2/files/Product/large/13443203307.jpg</a></li>
                        <li><a href="http://www.flickr.com/photos/vascorola/3164882131">http://www.flickr.com/photos/vascorola/3164882131</a></li>
                        <li><a href="http://www.flickr.com/photos/capcase/4970062156">http://www.flickr.com/photos/capcase/4970062156</a></li>
                        <li><a href="http://img.timeinc.net/time/photoessays/2009/monty_python/monty_python_02.jpg">http://img.timeinc.net/time/photoessays/2009/monty_python/monty_python_02.jpg</a></li>
                    </ul>
                </section>
            </div>

            <div class="footer"></div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.js"></script>
        <script src="../common/js/reveal.js"></script>
    </body>
</html>
