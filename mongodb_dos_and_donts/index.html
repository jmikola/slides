<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MongoDB DOs and DON'Ts</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.min.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/github.css">
        <link rel="stylesheet" href="../vendor/reveal.js/css/theme/sky.css">
        <link rel="stylesheet" href="css/main.css">

        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '../vendor/reveal.js/css/print/pdf.css';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        </script>

        <!--[if lt IE 9]>
        <script src="../vendor/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section data-state="title">
                    <h1><span class="logo-mongodb"></span> DO<span class="s">s</span> and DON'T<span class="s">s</span></h1>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">jmikola</a></p>
                </section>

                <section>
                    <h2>Topics</h2>

                    <div class="col-inline">
                        <ul>
                            <li>The New PHP Driver</li>
                            <li>Schema Design</li>
                            <li>Write Operations</li>
                        </ul>
                    </div>

                    <div class="col-inline">
                        <ul>
                            <li>Reading and Querying</li>
                            <li>Deployment and Ops</li>
                            <li>Object Document Mappers</li>
                        </ul>
                    </div>

                    <img src="img/dilbert-19960228.gif" alt="dilbert-19960228.gif" style="width: 100%; margin-top: 2em;">
                </section>
<!--
                <section>
                    <section>
                        <h2>Drivers</h2>
                    </section>

                    <section>
                        <h3>Developed by MongoDB</h3>

                        <div class="col-inline">
                            <ul>
                                <li>C</li>
                                <li>C++</li>
                                <li>C#</li>
                                <li>Erlang</li>
                                <li>Go</li>
                                <li>Java</li>
                            </ul>
                        </div>

                        <div class="col-inline">
                            <ul>
                                <li>Node.js</li>
                                <li>Perl</li>
                                <li>PHP</li>
                                <li>Python</li>
                                <li>Ruby</li>
                                <li>Scala</li>
                            </ul>
                        </div>

                        <p class="fragment" style="margin-top:2em;">Many more <a href="http://docs.mongodb.org/ecosystem/drivers/community-supported-drivers/">community-supported drivers</a><p>
                    </section>

                    <section class="spaced-out">
                        <h3>Enabling the Community</h3>

                        <p class="fragment"><a href="http://docs.mongodb.org/meta-driver/latest/">MongoDB meta driver</a></p>
                        <p class="fragment"><a href="https://github.com/mongodb/specifications">Server and driver specifications</a></p>
                    </section>

                    <section class="spaced-out">
                        <h3>Keep your driver up-to-date</h3>

                        <p class="fragment">Better support for old and new versions of MongoDB</p>
                        <p class="fragment">Most drivers follow <a href="http://semver.org/">semantic versioning</a></p>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t be limited to helper methods

                            * [`db.collection.aggregate()`](http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/)
                            * [`db.collection.distinct()`](http://docs.mongodb.org/manual/reference/method/db.collection.distinct/)
                            * [`db.collection.mapReduce()`](http://docs.mongodb.org/manual/reference/method/db.collection.mapReduce/)

                            <p class="fragment">Where&rsquo;s [`geoNear`](http://docs.mongodb.org/manual/reference/command/geoNear/)?</p>

                            <p class="fragment">[`db.runCommand()`](http://docs.mongodb.org/manual/reference/method/db.runCommand/)</p>
                        </script>
                    </section>
-->
                <section>
                    <section>
                        <h2>Introducing the New<br>PHP and HHVM Drivers</h2>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Hindsight is 20/20

                            An abridged list of things we have long<br>wanted to change about the legacy driver:

                            <br>

                            * Ambiguous deserialization of arrays and objects
                            * Positional arguments vs. options arrays
                            * Injecting generated IDs without pass-by-ref
                            * No clear strategy for adding command helpers
                            * Configuration via INI and static properties
                            * Multiple, inconsistent logging mechanisms
                            * Overall, a giant ball of unmaintainable C code
                        </script>
                    </section>

                    <section>
                        <h3>One New Driver, Three Engines</h3>

                        <br>

                        <table class="engines">
                            <tr>
                                <td><img src="img/engine-php5.jpg"></td>
                                <td><img src="img/engine-hhvm.jpg"></td>
                                <td><img src="img/engine-php7.jpg"></td>
                            </tr>
                            <tr>
                                <td>PHP 5</th>
                                <td>HHVM</th>
                                <td>PHP 7</th>
                            </tr>
                        </table>
                    </section>

                    <section>
                        <img src="img/new-architecture.png" class="transparent">
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Legacy API <small>(`ext-mongo`)</small>

                            ```
                            $m = new MongoClient('mongodb://localhost:27017');
                            $c = $m->demo->test;

                            $c->drop();

                            $c->insert([
                                'string' => 'bar',
                                'integer' => 55,
                                'bool' => true,
                                'null' => null,
                                'float' => M_PI,
                            ]);

                            foreach ($c->find() as $result) {
                                var_dump($result);
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### New API <small>(`ext-mongodb`)</small>

                            ```php
                            $m = new MongoDB\Driver\Manager('mongodb://localhost:27017');

                            $cmd = new MongoDB\Driver\Command(['drop' => 'test']);
                            $m->executeCommand('demo', $cmd);

                            $bulk = new MongoDB\Driver\BulkWrite;
                            $bulk->insert([
                                'string' => 'bar',
                                'integer' => 55,
                                'bool' => true,
                                'null' => null,
                                'float' => M_PI,
                            ]);

                            $m->executeBulkWrite('demo.test', $bulk);

                            $query = new MongoDB\Driver\Query([]);
                            $cursor = $m->executeQuery('demo.test', $query);

                            foreach ($cursor as $result) {
                                var_dump($result);
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Library API <small>(`mongodb/mongodb`)</small>

                            ```php
                            require 'vendor/autoload.php';

                            $m = new MongoDB\Client("mongodb://localhost:27017");
                            $c = $m->selectCollection('test', 'demo');

                            $c->drop();

                            $c->insertOne([
                                'string' => 'bar',
                                'integer' => 55,
                                'bool' => true,
                                'null' => null,
                                'float' => M_PI,
                            ]);

                            foreach ($c->find() as $result) {
                                var_dump($result);
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Where to find things

                            * [`ext-mongodb` for PHP 5 and 7](https://github.com/mongodb/mongo-php-driver/)
                            * [`ext-mongodb` for HHVM](https://github.com/mongodb/mongo-hhvm-driver/)
                            * [`mongodb/mongodb` library](https://github.com/mongodb/mongo-php-library/)
                            * [Legacy `ext-mongo` extension](https://github.com/mongodb/mongo-php-driver-legacy/)

                            <br>

                            More details in the [Architecture Overview](http://php.net/manual/en/mongodb.overview.php)<br>article in the driver documentation.
                        </script>
                    </section>
                </section>
<!--
                <section>
                    <section>
                        <h3>Persistent Connections</h3>

                        <p>Re-use connections within a PHP worker process.</p>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Not that you'd actually do this, but…

                            ```php
                            $m1 = new MongoClient('mongodb://localhost');
                            $m2 = new MongoClient('mongodb://localhost');
                            $m3 = new MongoClient('mongodb://user:pw@localhost');
                            $m4 = new MongoClient('mongodb://127.0.0.1');
                            $m5 = new MongoClient('mongodb://sharding.local:40017');
                            $m6 = new MongoClient(
                                'mongodb://primary.rs.local:30017,secondary.rs.local:30018',
                                ['replicaSet' => 'rs0']
                            );

                            $conns = $m1->getConnections();
                            $hashes = array_map(function($c) { return $c['hash']; }, $conns);

                            echo json_encode($hashes, JSON_PRETTY_PRINT);
                            ```
                        </script>
                    </section>

                    <section>
                        <h3>Distinguishing Connections</h3>

<pre><code class="language-javascript">[
    "localhost:27017;-;X;15487",                    // $m1, $m2
    "localhost:27017;-;admin/user/c56c…8bbc;15487", // $m3
    "127.0.0.1:27017;-;X;15487",                    // $m4
    "sharding.local:40017;-;X;15487",               // $m5
    "primary.rs.local:30017;rs0;X;15487",           // $m6
    "secondary.rs.local:30018;rs0;X;15487"          // $m6
]</code></pre>

                        <div class="col-left">
                            <ul>
                                <li>Host and port</li>
                                <li>Replica set</li>
                                <li>Process ID</li>
                            </ul>
                        </div>

                        <div class="col-right">
                            <ul>
                                <li>
                                    Authentication
                                    <ul>
                                        <li>Credentials</li>
                                        <li>Database</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t like persistent connections?

                            Call [MongoClient::close()](http://php.net/manual/en/mongoclient.close.php) after each request.

                            <span class="fragment">Don&rsquo;t actually do that.</span>
                        </script>
                    </section>
                </section>
-->
                <section>
                    <section>
                        <h2>Schema Design</h2>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Making do without joins

                            References, embedded objects, both?

                            Don&rsquo;t be afraid to denormalize.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Data Locality

                            ```javascript
                            {
                                _id: "jmikola",
                                name: "Jeremy Mikola",
                                friends: [ "bjori", "derickr" ]
                            }
                            ```

                            vs.

                            ```javascript
                            {
                                _id: "jmikola",
                                name: "Jeremy Mikola",
                                friends: [
                                    { id: "bjori", name: "Hannes Magnusson" },
                                    { id: "derickr", name: "Derick Rethans" }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Store computed values for querying

                            Counts or array lengths can be indexed and sorted.

                            Easily updated with `$inc` and `$set`.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t create field paths willy-nilly

                            ```javascript
                            > db.messages.findOne({}, { isReadByParticipant: 1 })
                            {
                                _id: ObjectId("4fce28482516ed983884b158"),
                                "isReadByParticipant" : {
                                    "4fce05e42516ed9838756f17" : false,
                                    "4fce05e42516ed9838756f18" : true,
                                    "4fce05e42516ed9838756f19" : true,
                                    "4fce05e42516ed9838756f1a" : false,
                                    "4fce05e42516ed9838756f1b" : false
                                }
                            }
                            ```

                            <span class="fragment">How can we index this?</span>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Multi-key indexing to the rescue

                            ```javascript
                            > db.messages.findOne({}, { unreadForParticipants: 1 })
                            {
                                _id: ObjectId("4fce28482516ed983884b158"),
                                "unreadForParticipants" : [
                                    "4fce05e42516ed9838756f17",
                                    "4fce05e42516ed9838756f1a",
                                    "4fce05e42516ed9838756f1b"
                                ]
                            }
                            ```

                            <small>A tidbit from [FOSMessageBundle](https://github.com/FriendsOfSymfony/FOSMessageBundle/pull/32)</small>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Multi-key indexing for EAV the rescue

                            ```javascript
                            > db.messages.findOne({}, { unreadForParticipants: 1 })
                            {
                                _id: ObjectId("4fce28482516ed983884b158"),
                                "unreadForParticipants" : [
                                    "4fce05e42516ed9838756f17",
                                    "4fce05e42516ed9838756f1a",
                                    "4fce05e42516ed9838756f1b"
                                ]
                            }
                            ```

                            <small>A tidbit from [FOSMessageBundle](https://github.com/FriendsOfSymfony/FOSMessageBundle/pull/32)</small>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Field paths and trees structures

                            ```javascript
                            > db.subjects.findOne()
                            {
                                _id: 1,
                                name: "American Literature",
                                sub_category: {
                                     name: "1920s",
                                     sub_category: { name: "Jazz Age" }
                                }
                            }
                            ```

                            One document contains the entire tree.

                            <span class="fragment">How can we query this?</span>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### A better tree schema

                            ```javascript
                            > db.subjects.find()
                            {
                                _id: "American Literature"
                            }

                            {
                                _id: "1920s",
                                parent: "American Literature"
                            }

                            {
                                _id: "Jazz Age",
                                parent: "1920s"
                            }
                            ```

                            <span class="fragment">How can we query for an entire branch?</span>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### But wait, there&rsquo;s more!

                            ```javascript
                            > db.subjects.find()
                            {
                                _id: "American Literature",
                                path: ["American Literature"]
                            }

                            {
                                _id: "1920s",
                                path: ["1920s", "American Literature"]
                            }

                            {
                                _id: "Jazz Age",
                                path: ["Jazz Age", "1920s", "American Literature"]
                            }
                            ```

                            Multi-key indexing on ``path`` allows branch querying, but relationship querying would require single-field index(es)
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t abuse schema flexibility

                            Create schemas that support your query patterns.

                            And then create indexes for those queries.
                        </script>
                    </section>

                    <section>
                        <h3>Make the most of your indexes</h3>

                        <ul>
                            <li class="fragment">Kill 2+ birds with one stone</li>
                            <li class="fragment">Compound and multi-key indexes</li>
                            <li class="fragment">Mind your read/write ratio</li>
                            <li class="fragment">Ensure query selectivity</li>
                        </ul>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t shoot in the dark

                            [Explain](http://docs.mongodb.org/manual/reference/explain/) your cursors.

                            [Profile](http://docs.mongodb.org/manual/tutorial/manage-the-database-profiler/) slow queries.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Further Reading

                            * [MongoDB for Analytics](https://speakerdeck.com/jnunemaker/mongodb-for-analytics-5) &ndash; John Nunemaker
                            * [Importing OpenStreetMap Data](http://derickrethans.nl/importing-osm-into-mongodb.html) &ndash; Derick Rethans
                            * [Use Cases](https://docs.mongodb.org/ecosystem/use-cases/) &ndash MongoDB manual
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Getting Your Data<br>into MongoDB</h2>

                        <br>

                        <h3 style="color: #999">And keeping it there&hellip;</h3>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Understanding `save()`&rsquo;s syntactic sugar

                            <img src="img/save-flowchart-2.png" alt="save-flowchart-2.png" style="width: 100%" class="transparent">
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Overloaded vs. Explicit Methods

                            <br>

                            Our [CRUD specification](https://github.com/mongodb/specifications) drops `save()` and defines<br>new operations for each legacy method mode:

                            <br>

                            <table class="crud-methods">
                                <tr>
                                    <th><code>insert()</code></th>
                                    <th><code>update()</code></th>
                                    <th><code>remove()</code></th>
                                </tr>
                                <tr>
                                    <td><code>insertOne()<br>insertMany()</code></td>
                                    <td><code>updateOne()<br>updateMany()<br>replaceOne()</code></td>
                                    <td><code>deleteOne()<br>deleteMany()</code></td>
                                </tr>
                            </table>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Use atomic operators where possible

                            <br>

                            ```javascript
                            document = db.users.findOne({ _id: "jmikola" });
                            document["friends"].push("pgodel");
                            db.users.replaceOne({ _id: document._id }, document);
                            ```

                            vs.

                            ```javascript
                            db.users.updateOne(
                                { _id: "jmikola" },
                                { $push: { friends: "pgodel" }}
                            );
                            ```
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Atomicity in MongoDB

                            No transactions for multi-document writes.

                            <p class="fragment">Emulate transactions with [two-phase commits](https://docs.mongodb.org/manual/tutorial/perform-two-phase-commits/).</p>

                            <p class="fragment">Single document updates *are* atomic.</p>

                            <p class="fragment">Can we query *and* update atomically?</p>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### The [findAndModify](http://docs.mongodb.org/manual/reference/command/findandmodify/) command

                            Atomically selects and modifies a<br>document in one of three modes:

                            <br>

                            * `findOneAndDelete()`
                            * `findOneAndReplace()`
                            * `findOneAndUpdate()`
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Implementing a simple job queue

                            ```javascript
                            // Insert a request to borrow a library book
                            db.loans.insertOne({
                                _id: { borrower: "bjori", book: ObjectId("…") },
                                approved: false,
                                pending: false
                                priority: 1
                            });

                            // Mark the highest priority request as pending
                            request = db.loans.findOneAndUpdate(
                                { pending: false },
                                { $set: { pending: true }},
                                { returnNewDocument: true, sort: { priority: -1 }}
                            );
                            ```
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Write Concern

                            <table class="options">
                                <tr>
                                    <th>0</th>
                                    <td>No write acknowledgement</td>
                                </tr>
                                <tr>
                                    <th>1</th>
                                    <td>Write acknowledgement from the primary (default)</td>
                                </tr>
                                <tr>
                                    <th style="color: #666">&lt;integer&gt;</th>
                                    <td>Write acknowledgement from <em>n</em> nodes</td>
                                </tr>
                                <tr>
                                    <th>"majority"</th>
                                    <td>Write acknowledgement from the majority of voting nodes (includes journaling)</td>
                                </tr>
                                <tr>
                                    <th style="color: #666">&lt;string&gt;</th>
                                    <td>Write acknowledgement to a node with the given <a href="http://docs.mongodb.org/manual/reference/replica-configuration/#tag-sets">tag set</a></td>
                                </tr>
                            </table>

                            Additional `wtimeout` and `journal` options.
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Document growth with [MMAPv1](https://docs.mongodb.org/manual/core/mmapv1/)

                            <p>Growing and relocation causes fragmentation.</p>

                            <p class="fragment">[Document storage may be padded](https://docs.mongodb.org/manual/core/mmapv1/#record-storage-characteristics).</p>

                            <p class="fragment">If possible, update documents [in-place](http://blog.mongodb.org/post/248614779/fast-updates-with-mongodb-update-in-place).</p>

                            <p class="fragment">Not relevant for [WiredTiger](https://docs.mongodb.org/manual/core/wiredtiger/), which uses<br>multiversion concurrency control (MVCC).</p>
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Reading and Querying</h2>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### If you remember only two things…

                            Index your queries.

                            Know your [working set](http://docs.mongodb.org/manual/faq/storage/#what-is-the-working-set).
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### [Read Preference](http://docs.mongodb.org/manual/applications/replication/#read-preference)

                            <table class="options">
                                <tr>
                                    <th>"primary"</th>
                                    <td>Select the primary (default)</td>
                                </tr>
                                <tr>
                                    <th>"primaryPreferred"</th>
                                    <td>Select the primary if available; fall back to a secondary</td>
                                </tr>
                                <tr>
                                    <th>"secondary"</th>
                                    <td>Select a secondary</td>
                                </tr>
                                <tr>
                                    <th>"secondaryPreferred"</th>
                                    <td>Select a secondary if available; fall back to the primary</td>
                                </tr>
                                <tr>
                                    <th>"nearest"</th>
                                    <td>Select the node with least network latency</td>
                                </tr>
                            </table>

                            <p class="fragment">[Tag sets](http://docs.mongodb.org/manual/reference/replica-configuration/#tag-sets) may be used for more fine-grained selection</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Read Concern

                            <table class="options">
                                <tr>
                                    <th>"local"</th>
                                    <td>Return the node&rsquo;s most recent copy of the data, which may be rolled back (default)</td>
                                </tr>
                                <tr>
                                    <th>"majority"</th>
                                    <td>Return the node&rsquo;s most recent copy of the data confirmed as written to a majority of the nodes (i.e. it cannot be rolled back)</td>
                                </tr>
                            </table>

                            <p class="fragment">Requires the WiredTiger storage engine and MongoDB 3.2+</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### JavaScript Evaluation

                            [`eval`](http://docs.mongodb.org/manual/reference/command/eval/) and [`$where`](http://docs.mongodb.org/manual/reference/operator/where/).

                            <p class="fragment">Would you use [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) in JavaScript?</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### MapReduce

                            We&rsquo;ll make an allowance for JavaScript here.

                            <p class="fragment">But try the [aggregation framework](http://docs.mongodb.org/manual/aggregation/) first.</p>
                        </script>
                    </section>

                    <section>
                        <h3>Aggregation Framework</h3>

                        <br>
                        <div class="mario-container">
                            <div class="mario-bg"></div>
                            <div class="mario-pipes"></div>
                            <div class="mario-sprite"></div>
                        </div>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Aggregation Framework

                            ```javascript
                            {
                                _id: "His Majesty's Dragon",
                                subjects: ["Fantasy", "Historical"],
                                published: ISODate("2006-03-28T00:00:00.000Z")
                            }
                            ```

                            &#x25BC;

                            ```javascript
                            db.books.aggregate([
                                { $sort: { created: 1 }},
                                { $unwind: "$subjects" },
                                { $group: {
                                    _id: "$subjects",
                                    total: { $sum: 1 },
                                    firstPublished: { $first: { $year: "$published" }}
                                }}
                            ]);
                            ```

                            &#x25BC;

                            ```javascript
                            { _id: "Fantasy", total: 6, "firstPublished": 2002 },
                            { _id: "Historical", total: 7, "firstPublished": 1974 },
                            { _id: "World Literature", total: 2, "firstPublished": 1995 }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### "But MongoDB doesn&rsquo;t do joins!"

                            `orders` collection:

                            ```javascript
                            { _id: 1, item: "abc", price: 12, quantity: 2 }
                            { _id: 2, item: "jkl", price: 20, quantity: 1 }
                            { _id: 3  }
                            ```

                            <br>

                            `inventory` collection:

                            ```javascript
                            { _id: 1, sku: "abc", description: "product 1", instock: 120 }
                            { _id: 2, sku: "def", description: "product 2", instock: 80 }
                            { _id: 3, sku: "ijk", description: "product 3", instock: 60 }
                            { _id: 4, sku: "jkl", description: "product 4", instock: 70 }
                            { _id: 5, sku: null, description: "Incomplete" }
                            { _id: 6 }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### "But MongoDB doesn&rsquo;t do joins!"

                            ```javascript
                            db.orders.aggregate([
                                { $lookup: {
                                    from: "inventory",
                                    localField: "item",
                                    foreignField: "sku",
                                    as: "inventory_docs"
                                }}
                            ]);
                            ```

                            &#x25BC;

                            ```javascript
                            {
                                _id: 1,
                                item: "abc",
                                price: 12,
                                quantity: 2,
                                inventory_docs : [
                                    { _id: 1, sku: "abc", description: "product 1", instock: 120 }
                                ]
                            }
                            ```

                            <p class="fragment">Usable with unsharded collection in the *same* database</p>
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Sharding and Replication</h2>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### The Players

                            * Application and driver
                            * `mongod`
                            * `mongod --replSet`
                            * `mongod --configsvr`
                            * `mongos`
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Replication vs. Sharding

                            <br>

                            Replication is the tool for data safety,<br>high availability, and disaster recovery.

                            <br>

                            Sharding is the tool for scaling a system.
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Replication

                            Always have an odd number of voting members.

                            <p class="fragment">Nodes can be [tagged](https://docs.mongodb.org/manual/tutorial/configure-replica-set-tag-sets/) (e.g. purpose, location).</p>

                            <p class="fragment">Take advantage of [priority](https://docs.mongodb.org/manual/tutorial/adjust-replica-set-member-priority/), [hidden](https://docs.mongodb.org/manual/core/replica-set-hidden-member/), and [delay](https://docs.mongodb.org/manual/core/replica-set-delayed-member/).</p>

                            <p class="fragment">Use tags to define [custom write concerns](https://docs.mongodb.org/manual/tutorial/configure-replica-set-tag-sets/#custom-multi-datacenter-write-concerns).</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Sharding

                            Each shard is a replica set or single `mongod`.

                            <p class="fragment">They can be [tagged](https://docs.mongodb.org/manual/core/tag-aware-sharding/), too.</p>

                            <p class="fragment">Not to be confused with replica set tags.</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Select a good shard key

                            This is *the* most important decision.
                        </script>
                    </section>

                    <section>
                        <img src="img/shard_key-1.png" alt="shard_key-1.png" style="width: 80%">

                        <p>Right-balanced Access</p>
                    </section>

                    <section>
                        <img src="img/shard_key-2.png" alt="shard_key-2.png" style="width: 80%">

                        <p>Random Access</p>
                    </section>

                    <section>
                        <img src="img/shard_key-3.png" alt="shard_key-3.png" style="width: 80%">

                        <p>Segmented Access</p>
                    </section>

                    <section>
                        <h3>Sharding without replication?</h3>

                        <img src="img/no-idea.gif" width="70%">
                    </section>

                    <section>
                        <h3>Replication, and maybe sharding?</h3>

                        <img src="img/brent-rambo.gif" width="70%">
                    </section>

                    <section>
                        <h3>What does sharding do for us?</h3>

                        <img src="img/sharding_cache-1.png" alt="sharding_cache-1.png" style="width: 80%;">
                    </section>

                    <section>
                        <h3>Sharding provides horizontal scalability</h3>

                        <img src="img/sharding_cache-2.png" alt="sharding_cache-2.png" style="width: 80%;">
                    </section>
<!--
                    <section>
                        <h3>Data, RAM and disk</h3>
                    </section>

                    <section>
                        <img src="img/memory-1.png" alt="memory-1.png" style="width: 80%;">
                    </section>

                    <section>
                        <img src="img/memory-2.png" alt="memory-2.png" style="width: 80%;">
                    </section>

                    <section>
                        <img src="img/memory-3.png" alt="memory-3.png" style="width: 80%;">
                    </section>

                    <section>
                        <img src="img/memory-4.png" alt="memory-4.png" style="width: 80%;">
                    </section>
-->
                    <section data-markdown>
                        <script type="text/template">
                            ### Keep an eye on RAM usage

                            ```no-highlight
                            $ free -b
                                         total       used       free    buffers     cached
                            Mem:    7307489280 6942613504  364875776  229281792 5872500736
                            -/+ buffers/cache:  840830976 6466658304
                            Swap:            0          0          0
                            ```

                            ```javascript
                            > var s = 0
                            0
                            > for each (var c in db.getCollectionNames()) {
                            ... s += db[c].totalIndexSize();
                            ... }
                            9784055680
                            ```

                            Can lead to intermittent page faults and disk access
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Object Document Mappers</h2>
                    </section>

                    <section class="spaced-out">
                        <h3>ODMs are a great tool</h3>

                        <ul>
                            <li class="fragment">Employ a real document model</li>
                            <li class="fragment">Framework and library integration</li>
                            <li class="fragment">Accelerate application development</li>
                            <li class="fragment">Abstract the database layer</li>
                        </ul>

                        <p class="fragment" style="margin-top: 1em;">Watch out for that last one.</p>

                        <p class="fragment">Grok your DB and driver <em>before</em> abstracting it.</p>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### The same principles apply

                            > Essentially the ORM can handle about 80-90% of the mapping problems, but that last chunk always needs careful work by somebody who really understands how a relational database works.

                            &mdash; Martin Fowler in [OrmHate](http://martinfowler.com/bliki/OrmHate.html)
                        </script>
                    </section>

                    <section>
                        <h3>A look at ODM functionality<br>in the new driver</h3>

                        <br>

                        <p class="fragment">Note: this is not a replacement for<br><a href="https://github.com/doctrine/mongodb-odm">Doctrine</a> and other full-featured ODMs</p>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Basic object mapping

                            ```php
                            class Person implements MongoDB\BSON\Persistable
                            {
                                private $id;
                                private $name;
                                private $addresses = [];

                                // Constructor, getters, and setters

                                public function bsonSerialize()
                                {
                                    return [
                                        '_id' => $this->id,
                                        'name' => $this->name,
                                        'addresses' => $this->addresses,
                                    ];
                                }

                                public function bsonUnserialize(array $data)
                                {
                                    $this->id = $data['_id'];
                                    $this->name = $data['name'];
                                    $this->addresses = $data['addresses'];
                                }
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### BSON arrays with the new driver

                            ```
                            class BSONArray extends \ArrayObject implements
                                MongoDB\BSON\Serializable,
                                MongoDB\BSON\Unserializable
                            {
                                public function bsonSerialize() {
                                    return array_values($this->getArrayCopy());
                                }

                                public function bsonUnserialize(array $data) {
                                    self::__construct($data);
                                }
                            }
                            ```

                            `array_values()` numerically reindexes the array<br>and ensures serialization to a BSON array.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### BSON objects with the new driver

                            ```
                            class BSONDocument extends \ArrayObject implements
                                MongoDB\BSON\Serializable,
                                MongoDB\BSON\Unserializable
                            {
                                public function bsonSerialize()
                                {
                                    return (object) $this->getArrayCopy();
                                }

                                public function bsonUnserialize(array $data)
                                {
                                    self::__construct($data, ArrayObject::ARRAY_AS_PROPS);
                                }
                            }
                            ```

                            Object casting ensures serialization to a document.<br>Construction during unserialization ensures<br>both offset (`[]`) and property (`->`) access.
                        </script>
                    </section>
                </section>

                <section data-markdown data-state="final">
                    <script type="text/template">
                        #### Thanks!

                        <br>

                        #### Questions?
                    </script>
                </section>

                <section data-state="photo-credits">
                    <h3>Photo Credits</h3>

                    <ul>
                        <li><a href="http://dilbert.com/strips/comic/1996-02-28">http://dilbert.com/strips/comic/1996-02-28</a></li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.min.js"></script>
        <script src="../common/js/reveal.js"></script>
    </body>
</html>
