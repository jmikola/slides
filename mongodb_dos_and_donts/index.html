<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MongoDB DOs and DON'Ts</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.min.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/github.css">
        <link rel="stylesheet" href="../vendor/reveal.js/css/theme/sky.css">
        <link rel="stylesheet" href="css/main.css">

        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '../vendor/reveal.js/css/print/pdf.css';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        </script>

        <!--[if lt IE 9]>
        <script src="../vendor/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section data-state="title">
                    <h1><span class="logo-mongodb"></span> DO<span class="s">s</span> and DON'T<span class="s">s</span></h1>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">jmikola</a></p>
                </section>

                <section data-state="contributors">
                    <a href="https://github.com/derickr"><img src="https://0.gravatar.com/avatar/2ef995275795830995d4241368713176?d=https%3A%2F%2Fidenticons.github.com%2F5350e19da7a913fef8751229986a509c.png&amp;s=140"></a>
                    <a href="https://github.com/bjori"><img src="https://2.gravatar.com/avatar/189511e30874ec6a3b583055f46fef78?d=https%3A%2F%2Fidenticons.github.com%2F46efca282b315142fbb5381ae47c8d45.png&amp;s=140"></a>
                    <a href="https://github.com/jmikola"><img src="https://0.gravatar.com/avatar/f23700b51dc0c196c1dc02f84aeeecdf?d=https%3A%2F%2Fidenticons.github.com%2F706249dd3fc0b178c58be9f85127d29e.png&amp;s=140"></a>

                    <br>

                    <span class="fragment"><a href="https://github.com/mongodb/mongo-php-driver"><img src="../common/img/mongodb_onlight.png" width="50%" class="transparent"></a></span>
                </section>

                <section>
                    <h2>Agenda</h2>

                    <img src="img/dilbert-19960228.gif" alt="dilbert-19960228.gif" style="width: 90%">

                    <div class="col-inline">
                        <ul>
                            <li>Drivers</li>
                            <li>Schema Design</li>
                            <li>Writing</li>
                        </ul>
                    </div>

                    <div class="col-inline">
                        <ul>
                            <li>Reading</li>
                            <li>Operations</li>
                            <li>ODMs</li>
                        </ul>
                    </div>
                </section>

                <section>
                    <section>
                        <h2>Drivers</h2>
                    </section>

                    <section>
                        <h3>Developed by MongoDB</h3>

                        <div class="col-inline">
                            <ul>
                                <li>C</li>
                                <li>C++</li>
                                <li>C#</li>
                                <li>Erlang</li>
                                <li>Go</li>
                                <li>Java</li>
                            </ul>
                        </div>

                        <div class="col-inline">
                            <ul>
                                <li>Node.js</li>
                                <li>Perl</li>
                                <li>PHP</li>
                                <li>Python</li>
                                <li>Ruby</li>
                                <li>Scala</li>
                            </ul>
                        </div>

                        <p class="fragment" style="margin-top:2em;">Many more <a href="http://docs.mongodb.org/ecosystem/drivers/community-supported-drivers/">community-supported drivers</a><p>
                    </section>

                    <section class="spaced-out">
                        <h3>Enabling the Community</h3>

                        <p class="fragment"><a href="http://docs.mongodb.org/meta-driver/latest/">MongoDB meta driver</a></p>
                        <p class="fragment"><a href="https://github.com/mongodb/specifications">Server and driver specifications</a></p>
                    </section>

                    <section class="spaced-out">
                        <h3>Keep your driver up-to-date</h3>

                        <p class="fragment">Better support for old and new versions of MongoDB</p>
                        <p class="fragment">Most drivers follow <a href="http://semver.org/">semantic versioning</a></p>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t be limited to helper methods

                            * [`db.collection.aggregate()`](http://docs.mongodb.org/manual/reference/method/db.collection.aggregate/)
                            * [`db.collection.distinct()`](http://docs.mongodb.org/manual/reference/method/db.collection.distinct/)
                            * [`db.collection.mapReduce()`](http://docs.mongodb.org/manual/reference/method/db.collection.mapReduce/)

                            <p class="fragment">Where&rsquo;s [`geoNear`](http://docs.mongodb.org/manual/reference/command/geoNear/)?</p>

                            <p class="fragment">[`db.runCommand()`](http://docs.mongodb.org/manual/reference/method/db.runCommand/)</p>
                        </script>
                    </section>
<!--
                    <section>
                        <h3>Persistent Connections</h3>

                        <p>Re-use connections within a PHP worker process.</p>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Not that you'd actually do this, but…

                            ```php
                            $m1 = new MongoClient('mongodb://localhost');
                            $m2 = new MongoClient('mongodb://localhost');
                            $m3 = new MongoClient('mongodb://user:pw@localhost');
                            $m4 = new MongoClient('mongodb://127.0.0.1');
                            $m5 = new MongoClient('mongodb://sharding.local:40017');
                            $m6 = new MongoClient(
                                'mongodb://primary.rs.local:30017,secondary.rs.local:30018',
                                ['replicaSet' => 'rs0']
                            );

                            $conns = $m1->getConnections();
                            $hashes = array_map(function($c) { return $c['hash']; }, $conns);

                            echo json_encode($hashes, JSON_PRETTY_PRINT);
                            ```
                        </script>
                    </section>

                    <section>
                        <h3>Distinguishing Connections</h3>

<pre><code class="language-javascript">[
    "localhost:27017;-;X;15487",                    // $m1, $m2
    "localhost:27017;-;admin/user/c56c…8bbc;15487", // $m3
    "127.0.0.1:27017;-;X;15487",                    // $m4
    "sharding.local:40017;-;X;15487",               // $m5
    "primary.rs.local:30017;rs0;X;15487",           // $m6
    "secondary.rs.local:30018;rs0;X;15487"          // $m6
]</code></pre>

                        <div class="col-left">
                            <ul>
                                <li>Host and port</li>
                                <li>Replica set</li>
                                <li>Process ID</li>
                            </ul>
                        </div>

                        <div class="col-right">
                            <ul>
                                <li>
                                    Authentication
                                    <ul>
                                        <li>Credentials</li>
                                        <li>Database</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t like persistent connections?

                            Call [MongoClient::close()](http://php.net/manual/en/mongoclient.close.php) after each request.

                            <span class="fragment">Don&rsquo;t actually do that.</span>
                        </script>
                    </section>
-->
                </section>

                <section>
                    <section>
                        <h2>Schema Design</h2>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Making do without joins

                            References, embedded objects, both?

                            Don&rsquo;t be afraid to denormalize.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Data Locality

                            ```javascript
                            {
                                _id: "jmikola",
                                name: "Jeremy Mikola",
                                friends: [ "bjori", "derickr" ]
                            }
                            ```

                            vs.

                            ```javascript
                            {
                                _id: "jmikola",
                                name: "Jeremy Mikola",
                                friends: [
                                    { id: "bjori", name: "Hannes Magnusson" },
                                    { id: "derickr", name: "Derick Rethans" }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Store computed values for querying

                            Counts or array lengths can be indexed and sorted.

                            Easily updated with `$inc` and `$set`.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t create field paths willy-nilly

                            ```javascript
                            > db.messages.findOne({}, { isReadByParticipant: 1 })
                            {
                                "_id" : ObjectId("4fce28482516ed983884b158"),
                                "isReadByParticipant" : {
                                    "4fce05e42516ed9838756f17" : false,
                                    "4fce05e42516ed9838756f18" : true,
                                    "4fce05e42516ed9838756f19" : true,
                                    "4fce05e42516ed9838756f1a" : false,
                                    "4fce05e42516ed9838756f1b" : false
                                }
                            }
                            ```

                            How do we index this‽
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Multi-key indexing to the rescue

                            ```javascript
                            > db.messages.findOne({}, { unreadForParticipants: 1 })
                            {
                                "_id" : ObjectId("4fce28482516ed983884b158"),
                                "unreadForParticipants" : [
                                    "4fce05e42516ed9838756f17",
                                    "4fce05e42516ed9838756f1a",
                                    "4fce05e42516ed9838756f1b"
                                ]
                            }
                            ```

                            <small>A tidbit from [FOSMessageBundle](https://github.com/FriendsOfSymfony/FOSMessageBundle/pull/32)</small>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Field paths and trees structures

                            ```javascript
                            > db.subjects.findOne()
                            {
                                _id: 1,
                                name: "American Literature",
                                sub_category: {
                                     name: "1920s",
                                     sub_category: { name: "Jazz Age" }
                                }
                            }
                            ```

                            One document contains the entire tree.

                            <span class="fragment">How do we query this‽</span>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### A better tree schema

                            ```javascript
                            > db.subjects.find()
                            { _id: "American Literature" }

                            {
                                _id: "1920s",
                                parent: "American Literature"
                            }

                            {
                                _id: "Jazz Age",
                                parent: "1920s"
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### But wait, there&rsquo;s more!

                            ```javascript
                            > db.subjects.find()
                            { _id: "American Literature" }

                            {
                                _id: "1920s",
                                ancestors: ["American Literature"],
                                parent: "American Literature"
                            }

                            {
                                _id: "Jazz Age",
                                ancestors: ["American Literature", "1920s"],
                                parent: "1920s"
                            }
                            ```
                        </script>
                    </section>

                    <section class="spaced-out">
                        <h3>Working with analytics?</h3>

                        <p><a href="https://speakerdeck.com/jnunemaker/mongodb-for-analytics-3">MongoDB for Analytics</a><br>&mdash; John Nunemaker</p>
                    </section>

                    <section>
                        <iframe class="speakerdeck-iframe" style="border: 0px; background-color: transparent; margin: 0px; padding: 0px; border-top-left-radius: 5px; border-top-right-radius: 5px; border-bottom-right-radius: 5px; border-bottom-left-radius: 5px; width: 20em; height: 17em; background-position: initial initial; background-repeat: initial initial;" frameborder="0" src="https://speakerdeck.com/player/981aa470220c01305d2612313933acc8?slide=39" allowfullscreen="true" mozallowfullscreen="true" webkitallowfullscreen="true"></iframe>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t abuse schema flexibility

                            Create schemas that support your query patterns.

                            And then create indexes for those queries.
                        </script>
                    </section>

                    <section>
                        <h3>Make the most of your indexes</h3>

                        <ul>
                            <li class="fragment">Kill 2+ birds with one stone</li>
                            <li class="fragment">Compound and multi-key indexes</li>
                            <li class="fragment">Mind your read/write ratio</li>
                            <li class="fragment">Ensure query selectivity</li>
                        </ul>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Don&rsquo;t shoot in the dark

                            [Explain](http://docs.mongodb.org/manual/reference/explain/) your cursors.

                            [Profile](http://docs.mongodb.org/manual/tutorial/manage-the-database-profiler/) slow queries.
                        </script>
                    </section>

                    <section>
                        <img src="img/mongoqp.png" alt="mongoqp.png" style="width: 100%" class="transparent">
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Writing</h2>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Use Atomic Operators

                            ```javascript
                            document = db.users.find({ _id: "jmikola" });
                            document["friends"].push("pgodel");
                            db.users.save(document);
                            ```

                            vs.

                            ```javascript
                            db.users.update(
                                { _id: "jmikola" },
                                { $push: { friends: "pgodel" }}
                            );
                            ```
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Atomicity

                            No transactions for multi-document writes.

                            <p class="fragment">Single document updates *are* atomic.</p>

                            <p class="fragment">Can we query *and* update atomically?</p>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### findAndModify

                            ```javascript
                            // Request to borrow a library book
                            db.loans.insert({
                                _id: { borrower: "bjori", book: ObjectId("…") },
                                pending: false,
                                approved: false,
                                priority: 1
                            });

                            // Find the highest priority request; mark as pending approval
                            request = db.loans.findAndModify({
                                query: { pending: false },
                                sort: { priority: -1 },
                                update: { $set: { pending: true, started: new ISODate() }},
                                new: true
                            });
                            ```

                            And that&rsquo;s a job queue.
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Write Concerns

                            `w` replaces `safe`.

                            <span class="fragment">`w=1` is the default.</span>

                            <span class="fragment">`w=majority` for replication.</span>

                            <span class="fragment">[Tag sets](http://docs.mongodb.org/manual/reference/replica-configuration/#tag-sets) and journaling, too.</span>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Dealing with document growth

                            [Padding factor](http://docs.mongodb.org/manual/core/write-operations/#padding-factor) is a thing.

                            <p class="fragment">Growing and relocation causes fragmentation.</p>

                            <p class="fragment">If possible, update documents [in-place](http://blog.mongodb.org/post/248614779/fast-updates-with-mongodb-update-in-place).</p>

                            <p class="fragment">Good schema design can help.</p>
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Reading</h2>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### If you remember only two things…

                            Index your queries.

                            Know your [working set](http://docs.mongodb.org/manual/faq/storage/#what-is-the-working-set).
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### [Read Preferences](http://docs.mongodb.org/manual/applications/replication/#read-preference)

                            `secondaryPreferred` replaces `slaveOk`.

                            <p class="fragment">`primary`, `primaryPreferred`<br>`secondary`, `nearest`</p>

                            <p class="fragment">[Tag sets](http://docs.mongodb.org/manual/reference/replica-configuration/#tag-sets)? You bet!</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### JavaScript Evaluation

                            [`eval`](http://docs.mongodb.org/manual/reference/command/eval/) and [`$where`](http://docs.mongodb.org/manual/reference/operator/where/).

                            <p class="fragment">Would you use [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) in JavaScript?</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### MapReduce

                            We&rsquo;ll make an allowance for JavaScript here.

                            <p class="fragment">But try the [aggregation framework](http://docs.mongodb.org/manual/aggregation/) first.</p>
                        </script>
                    </section>

                    <section>
                        <h3>Aggregation Framework</h3>

                        <br>
                        <div class="mario-container">
                            <div class="mario-bg"></div>
                            <div class="mario-pipes"></div>
                            <div class="mario-sprite"></div>
                        </div>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Aggregation Framework

                            ```javascript
                            db.books.aggregate([
                              { $sort: { created: 1 }},
                              { $unwind: "$subjects" },
                              { $group: {
                                _id: "$subjects",
                                count: { $sum: 1 },
                                firstCreated: { $first: { $year: "$created" }}
                              }}
                            ]);
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>Operations</h2>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### The Players

                            * Application and driver
                            * `mongod`
                            * `mongod --replSet`
                            * `mongod --configsvr`
                            * `mongos`
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Replication vs. Sharding

                            <br>

                            Replication is the tool for data safety,<br>high availability, and disaster recovery.

                            <br>

                            Sharding is the tool for scaling a system.
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Replication

                            Always have an odd number of voting members.

                            <p class="fragment">Nodes can be [tagged](http://docs.mongodb.org/manual/reference/replica-configuration/#tag-sets) (e.g. purpose, location).</p>

                            <p class="fragment">Take advantage of [priority](http://docs.mongodb.org/manual/core/replication/#replica-set-node-priority), [hidden](http://docs.mongodb.org/manual/administration/replica-sets/#replica-set-hidden-members), and [delay](http://docs.mongodb.org/manual/administration/replica-sets/#delayed-members).</p>

                            <p class="fragment">Use tags to define [custom write concerns](http://docs.mongodb.org/manual/applications/replication/#custom-write-propagation-modes).</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Sharding

                            Each shard is a replica set or single `mongod`.

                            <p class="fragment">They can be [tagged](http://docs.mongodb.org/manual/administration/tag-aware-sharding/#tag-aware-sharding), too.</p>

                            <p class="fragment">Not to be confused with replica set tags.</p>
                        </script>
                    </section>

                    <section class="spaced-out" data-markdown>
                        <script type="text/template">
                            ### Select a good shard key

                            This is *the* most important decision.
                        </script>
                    </section>

                    <section>
                        <img src="img/shard_key-1.png" alt="shard_key-1.png" style="width: 80%">

                        <p>Right-balanced Access</p>
                    </section>

                    <section>
                        <img src="img/shard_key-2.png" alt="shard_key-2.png" style="width: 80%">

                        <p>Random Access</p>
                    </section>

                    <section>
                        <img src="img/shard_key-3.png" alt="shard_key-3.png" style="width: 80%">

                        <p>Segmented Access</p>
                    </section>

                    <section>
                        <h3>Sharding without replication?</h3>

                        <img src="img/dog_no_idea.jpg" alt="dog_no_idea.jpg" width="70%">
                    </section>

                    <section>
                        <h3>Replication, and maybe sharding?</h3>

                        <img src="img/brent-rambo.gif" width="70%">
                    </section>

                    <section>
                        <h3>Data, RAM and disk</h3>
                    </section>

                    <section>
                        <img src="img/memory-1.png" alt="memory-1.png" style="width: 80%;">
                    </section>

                    <section>
                        <img src="img/memory-2.png" alt="memory-2.png" style="width: 80%;">
                    </section>

                    <section>
                        <img src="img/memory-3.png" alt="memory-3.png" style="width: 80%;">
                    </section>

                    <section>
                        <img src="img/memory-4.png" alt="memory-4.png" style="width: 80%;">
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Keep an eye on RAM usage

                            ```no-highlight
                            $ free -b
                                         total       used       free    buffers     cached
                            Mem:    7307489280 6942613504  364875776  229281792 5872500736
                            -/+ buffers/cache:  840830976 6466658304
                            Swap:            0          0          0
                            ```

                            ```javascript
                            > var s = 0
                            0
                            > for each (var c in db.getCollectionNames()) {
                            ... s += db[c].totalIndexSize();
                            ... }
                            9784055680
                            ```

                            Intermittent page faults and disk access.
                        </script>
                    </section>

                    <section>
                        <h3>What does sharding do for us?</h3>

                        <img src="img/sharding_cache-1.png" alt="sharding_cache-1.png" style="width: 80%;">
                    </section>

                    <section>
                        <h3>Sharding provides horizontal scalability</h3>

                        <img src="img/sharding_cache-2.png" alt="sharding_cache-2.png" style="width: 80%;">
                    </section>
                </section>

                <section>
                    <section>
                        <h2>ODMs</h2>
                    </section>

                    <section class="spaced-out">
                        <h3>ODMs are a great tool</h3>

                        <ul>
                            <li class="fragment">Employ a real document model</li>
                            <li class="fragment">Framework and library integration</li>
                            <li class="fragment">Accelerate application development</li>
                            <li class="fragment">Abstract the database layer</li>
                        </ul>

                        <p class="fragment" style="margin-top: 1em;">Watch out for that last one.</p>

                        <p class="fragment">Grok your DB and driver <em>before</em> abstracting it.</p>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### The same principles apply

                            > Essentially the ORM can handle about 80-90% of the mapping problems, but that last chunk always needs careful work by somebody who really understands how a relational database works.

                            &mdash; Martin Fowler in [OrmHate](http://martinfowler.com/bliki/OrmHate.html)
                        </script>
                    </section>
                </section>

                <section data-markdown>
                    <script type="text/template">
                        ## That&rsquo;s a wrap

                        * <strike>Drivers</strike>
                        * <strike>Schema Design</strike>
                        * <strike>Writing</strike>
                        * <strike>Reading</strike>
                        * <strike>Operations</strike>
                        * <strike>ODMs</strike>
                    </script>
                </section>

                <section data-markdown data-state="final">
                    <script type="text/template">
                        # Thanks!

                        <br>

                        ### Questions?
                    </script>
                </section>

                <section data-state="photo-credits">
                    <h3>Photo Credits</h3>

                    <ul>
                        <li><a href="http://dilbert.com/strips/comic/1996-02-28">http://dilbert.com/strips/comic/1996-02-28</a></li>
                    </ul>
                </section>
            </div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.min.js"></script>
        <script src="../common/js/reveal.js"></script>
    </body>
</html>
