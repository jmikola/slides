<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>MongoDB Schema Design Workshop</title>
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

        <link rel="stylesheet" href="../vendor/reveal.js/css/reveal.css">
        <link rel="stylesheet" href="../vendor/highlight.js/src/styles/github.css">
        <link rel="stylesheet" href="../common/css/theme/10gen.css">
        <link rel="stylesheet" href="css/main.css">

        <script>
            if( window.location.search.match( /print-pdf/gi ) ) {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '../vendor/reveal.js/css/print/pdf.css';
                document.getElementsByTagName('head')[0].appendChild(link);
            }
        </script>

        <!--[if lt IE 9]>
        <script src="../vendor/reveal.js/lib/js/html5shiv.js"></script>
        <![endif]-->
    </head>

    <body>
        <div class="reveal">
            <div class="slides">
                <section data-state="title">
                    <h1><span class="logo-mongodb"></span> Schema Design Workshop</h1>

                    <p class="bio">Jeremy Mikola<br><a href="http://twitter.com/jmikola">@jmikola</a></p>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Agenda

                            1. Basic schema design principles for MongoDB
                            2. Schema design over an application&rsquo;s lifetime
                            3. Common design patterns
                            4. Sharding
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            # Goals

                            * Learn the schema design process in MongoDB
                            * Practice applying common principles via exercises
                            * Understand the implications of sharding
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h2>What is a schema and why is it important?</h2>
                    </section>

                    <section data-markdown data-state="library" class="bg">
                        <script type="text/template">
                            # Schema

                            * Map concepts and relationships to data
                            * Set expectations for the data
                            * Minimize overhead of iterative modifications
                            * Ensure compatibility
                        </script>
                    </section>

                    <section data-markdown data-state="normalize-denormalize">
                        <script type="text/template">
                            ## Normalization

                            <div class="node-3">
                                <div class="node">
                                    <span class="label">users</span>
                                    <ul>
                                        <li><code>username</code></li>
                                        <li><code>first_name</code></li>
                                        <li><code>last_name</code></li>
                                    </ul>
                                </div>
                                <div class="arrow">&larr;</div>
                                <div class="node">
                                    <span class="label">books</span>
                                    <ul>
                                        <li><code>title</code></li>
                                        <li><code>isbn</code></li>
                                        <li><code>language</code></li>
                                        <li><code>created_by</code></li>
                                        <li><code>author</code></li>
                                    </ul>
                                </div>
                                <div class="arrow">&rarr;</div>
                                <div class="node">
                                    <span class="label">authors</span>
                                    <ul>
                                        <li><code>first_name</code></li>
                                        <li><code>last_name</code></li>
                                    </ul>
                                </div>
                            </div>
                        </script>
                    </section>

                    <section data-markdown data-state="normalize-denormalize">
                        <script type="text/template">
                            ## Denormalization

                            <div class="node-3">
                                <div class="node">
                                    <span class="label">users</span>
                                    <ul>
                                        <li><code>username</code></li>
                                        <li><code>first_name</code></li>
                                        <li><code>last_name</code></li>
                                    </ul>
                                </div>
                                <div class="arrow">&larr;</div>
                                <div class="node">
                                    <span class="label">books</span>
                                    <ul>
                                        <li><code>title</code></li>
                                        <li><code>isbn</code></li>
                                        <li><code>language</code></li>
                                        <li><code>created_by</code></li>
                                        <li class="embedded-object">
                                            <code>author</code>
                                            <ul>
                                                <li><code>first_name</code></li>
                                                <li><code>last_name</code></li>
                                            </ul>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## What is schema design like in MongoDB?

                            * Schema is defined at the application-level
                            * Design is part of each phase in its lifetime
                            * There is no magic formula
                        </script>
                    </section>

                    <section data-markdown class="ul-2col">
                        <script type="text/template">
                            ## MongoDB Documents

                            Storage in BSON &rarr; <a href="http://bsonspec.org/">BSONSpec.org</a>

                            * Scalars
                                * Doubles
                                * Integers (32 or 64-bit)
                                * UTF-8 strings
                                * UTC Date, timestamp
                                * Binary, regex, code
                                * Object ID
                                * `null`
                            * Rich types
                                * Objects
                                * Arrays
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Terminology

                            ```javascript
                            {
                                "mongodb"    : "relational db",
                                "database"   : "database",
                                "collection" : "table",
                                "document"   : "row",
                                "field"      : "column",
                                "index"      : "index",
                                "sharding" : {
                                    "shard"     : "partition",
                                    "shard key" : "partition key"
                                }
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Three Considerations in MongoDB Schema Design

                            1. The data your application needs
                            2. Your application&rsquo;s read usage of the data
                            3. Your application&rsquo;s write usage of the data
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown data-state="library" class="bg">
                        <script type="text/template">
                            # Case Study

                            ## Library Web Application

                            Different schemas are possible
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Author Schema

                            ```javascript
                            {
                                "_id": int,
                                "first_name": string,
                                "last_name": string
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## User Schema

                            ```javascript
                            {
                                "_id": int,
                                "username": string,
                                "password": string
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Book Schema

                            ```javascript
                            {
                                "_id": int,
                                "title": string,
                                "slug": string,
                                "author": int,
                                "available": boolean,
                                "isbn": string,
                                "pages": int,
                                "publisher": {
                                    "city": string,
                                    "date": date,
                                    "name": string
                                },
                                "subjects": [ string, string ],
                                "language": string,
                                "reviews": [
                                   { "user": int, "text": string },
                                   { "user": int, "text": string }
                                ],
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h1>Example Documents</h1>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Author Document

                            ```javascript
                            > db.authors.findOne()
                            {
                                _id: 1,
                                first_name: "F. Scott",
                                last_name: "Fitzgerald"
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## User Document

                            ```javascript
                            > db.users.findOne()
                            {
                                _id: 1,
                                username: "emily@10gen.com",
                                password: "slsjfk4odk84k209dlkdj90009283d"
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Book Document

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: 1,
                                available: true,
                                isbn: "9781857150193",
                                pages: 176,
                                publisher: {
                                    name: "Everyman's Library",
                                    date: ISODate("1991-09-19T00:00:00Z"),
                                    city: "London"
                                },
                                subjects: ["Love stories", "1920s", "Jazz Age"],
                                language: "English",
                                reviews: [
                                   { user: 1, text: "One of the best…" },
                                   { user: 2, text: "It's hard to…" }
                                ]
                            }
                            ```
                        </script>
                    </section>
               </section>

               <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Embedded Objects

                            #### AKA embedded or sub-documents

                            What advantages do they have?

                            When should they be used?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Embedded Objects

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: 1,
                                available: true,
                                isbn: "9781857150193",
                                pages: 176,
                            <span class="code-highlight inline-block">    publisher: {
                                    name: "Everyman's Library",
                                    date: ISODate("1991-09-19T00:00:00Z"),
                                    city: "London"
                                },</span>
                                subjects: ["Love stories", "1920s", "Jazz Age"],
                                language: "English",
                                reviews: [
                                   { user: 1, text: "One of the best…" },
                                   { user: 2, text: "It's hard to…" }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Embedded Objects

                            * Great for read performance
                            * One seek to load the entire document
                            * One round trip to the database
                            * Writes can be slow if constantly adding to objects
                        </script>
                    </section>
               </section>

               <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Linked Documents

                            What advantages does this approach have?

                            When should they be used?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Linked Documents

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                            <span class="code-highlight inline-block">    author: 1,</span>
                                available: true,
                                isbn: "9781857150193",
                                pages: 176,
                                publisher: {
                                    publisher_name: "Everyman's Library",
                                    date: ISODate("1991-09-19T00:00:00Z"),
                                    publisher_city: "London"
                                },
                                subjects: ["Love stories", "1920s", "Jazz Age"],
                                language: "English",
                                reviews: [
                                   { <span class="code-highlight">user: 1</span>, text: "One of the best…" },
                                   { <span class="code-highlight">user: 2</span>, text: "It's hard to…" }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Linked Documents

                            * More, smaller documents
                            * Can make queries by ID very simple
                            * Accessing linked document data requires extra read
                            * What effect does this have on the system?
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h1>Data, RAM and Disk</h1>
                    </section>

                    <section>
                        <img src="img/memory-1.png" alt="memory-1.png">
                    </section>

                    <section>
                        <img src="img/memory-2.png" alt="memory-2.png">
                    </section>

                    <section>
                        <img src="img/memory-3.png" alt="memory-3.png">
                    </section>

                    <section>
                        <img src="img/memory-4.png" alt="memory-4.png">
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Arrays

                            When should they be used?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of Scalars

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: 1,
                                available: true,
                                isbn: "9781857150193",
                                pages: 176,
                                publisher: {
                                    name: "Everyman's Library",
                                    date: ISODate("1991-09-19T00:00:00Z"),
                                    city: "London"
                                },
                                subjects: ["Love stories", "1920s", "Jazz Age"],
                                language: "English",
                                reviews: [
                                   { user: 1, text: "One of the best…" },
                                   { user: 2, text: "It's hard to…" }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of Objects

                            ```javascript
                            > db.books.findOne()
                            {   _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: 1,
                                available: true,
                                isbn: "9781857150193",
                                pages: 176,
                                publisher: {
                                    name: "Everyman's Library",
                                    date: ISODate("1991-09-19T00:00:00Z"),
                                    city: "London"
                                },
                                subjects: ["Love stories", "1920s", "Jazz Age"],
                                language: "English",
                                reviews: [
                                   { user: 1, text: "One of the best…" },
                                   { user: 2, text: "It's hard to…" }
                                ],
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown class="ul-2col">
                        <script type="text/template">
                            ## Exercise #1

                            Design a schema for users and their book reviews

                            * Users
                                * username (string)
                                * email (string)
                            * Reviews
                                * text (string)
                                * rating (integer)
                                * created_at (date)

                            *Usernames are immutable*
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #1: Solution A

                            Reviews may be queried by user or book

                            ```javascript
                            // db.users (one document per user)
                            {   _id: ObjectId("…"),
                                username: "bob",
                                email: "bob@example.com"
                            }
                            ```

                            ```javascript
                            // db.reviews (one document per review)
                            {   _id: ObjectId("…"),
                                user: ObjectId("…"),
                                book: ObjectId("…"),
                                rating: 5,
                                text: "This book is excellent!",
                                created_at: ISODate("2012-10-10T21:14:07.096Z")
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #1: Solution B

                            Optimized to retrieve reviews by user

                            ```javascript
                            // db.users (one document per user with all reviews)
                            {   _id: ObjectId("…"),
                                username: "bob",
                                email: "bob@example.com",
                                reviews: [
                                    {   book: ObjectId("…"),
                                        rating: 5,
                                        text: "This book is excellent!",
                                        created_at: ISODate("2012-10-10T21:14:07.096Z")
                                    }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #1: Solution C

                            Optimized to retrieve reviews by book

                            ```javascript
                            // db.users (one document per user)
                            {   _id: ObjectId("…"),
                                username: "bob",
                                email: "bob@example.com"
                            }
                            ```

                            ```javascript
                            // db.books (one document per book with all reviews)
                            {   _id: ObjectId("…"),
                                // Other book fields…
                                reviews: [
                                    {   user: ObjectId("…"),
                                        rating: 5,
                                        text: "This book is excellent!",
                                        created_at: ISODate("2012-10-10T21:14:07.096Z")
                                    }
                                ]
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Schema Design Over an Application&rsquo;s Lifetime

                            * Development
                            * Production
                            * Iterative Modifications
                        </script>
                    </section>
                 </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Development Phase

                            Basic CRUD functionality
                        </script>
                    </section>
                 </section>

                 <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Create<span class="crud">RUD</span>

                            ```javascript
                            author = {
                                _id: 2,
                                first_name: "Arthur",
                                last_name: "Miller"
                            };

                            db.authors.insert(author);
                            ```

                            * The `_id` field is unique and automatically indexed
                            * MongoDB will generate an [ObjectId](http://www.mongodb.org/display/DOCS/Object+IDs#ObjectIDs-BSONObjectIDSpecification) if not provided
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # <span class="crud">C</span>Read<span class="crud">UD</span>

                            ```javascript
                            > db.authors.find({ "last_name": "Miller" })
                            {
                                _id: 2,
                                first_name: "Arthur",
                                last_name: "Miller"
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Reads and Indexing

                            Examine the query after creating an index.

                            ```javascript
                            > db.books.ensureIndex({ "slug": 1 })

                            > db.books.find({ "slug": "the-great-gatsby" }).explain()
                            {
                                "cursor": "BtreeCursor slug_1",
                                "isMultiKey" : false,
                                "n" : 1,
                                "nscannedObjects" : 1,
                                "nscanned" : 1,
                                "scanAndOrder" : false,
                                "indexOnly" : false,
                                "nYields" : 0,
                                "nChunkSkips" : 0,
                                "millis" : 0,
                                // Other fields follow…
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Multi-key Indexes

                            Index all values in an array field.

                            ```javascript
                            > db.books.ensureIndex({ "subjects": 1 })
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Indexing Embedded Fields

                            Index an embedded object&rsquo;s field.

                            ```javascript
                            > db.books.ensureIndex({ "publisher.name": 1 })
                            ```
                        </script>
                     </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Query operators

                            * Conditional operators
                                * `$gt`, `$gte`, `$lt`, `$lte`, `$ne`, `$all`, `$in`, `$nin`, `$size`, `$and`, `$or`, `$nor`, `$mod`, `$type`, `$exists`
                            * Regular expressions
                            * Value in an array
                                * `$elemMatch`
                            * Cursor methods and modifiers
                                * `count()`, `limit()`, `skip()`, `snapshot()`, `sort()`, `batchSize()`, `explain()`, `hint()`
                        </script>
                    </section>
                 </section>

                 <section>
                    <section data-markdown>
                        <script type="text/template">
                            # <span class="crud">CR</span>Update<span class="crud">D</span>

                            ```javascript
                            review = {
                                user: 1,
                                text: "I did NOT like this book."
                            };

                            db.books.update(
                                { _id: 1 },
                                { $push: { reviews: review }}
                            );
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Atomic Modifiers

                            Update specific fields within a document

                            * `$set`, `$unset`
                            * `$push`, `$pushAll`
                            * `$addToSet`, `$pop`
                            * `$pull`, `$pullAll`
                            * `$rename`
                            * `$bit`
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # <span class="crud">CRU</span>Delete

                            ```javascript
                            > db.books.remove({ _id: 1 })
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Production Phase

                            Evolve schema to meet the application&rsquo;s read and write patterns
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Read Usage

                            Finding books by an author&rsquo;s first name

                            ```javascript
                            authors = db.authors.find({ first_name: /^f.*/i }, { _id: 1 });

                            authorIds = authors.map(function(x) { return x._id; });

                            db.books.find({author: { $in: authorIds }});
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Read Usage

                            "Cache" the author name in an embedded document

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                author: {
                                    first_name: "F. Scott",
                                    last_name: "Fitzgerald"
                                }
                                // Other fields follow…
                            }
                            ```

                            Queries are now one step

                            ```javascript
                            > db.books.find({ "author.first_name": /^f.*/i })
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Write Usage

                            Users can review a book

                            ```javascript
                            review = {
                                user: 1,
                                text: "I thought this book was great!",
                                rating: 5
                            };

                            > db.books.update(
                                { _id: 3 },
                                { $push: { reviews: review }}
                            );
                            ```

                            * Document size limit (16MB)
                            * Storage fragmentation after many updates/deletes
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #2

                            * Display the 10 most recent reviews by a user
                            * Make efficient use of memory and disk seeks
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #2: Solution

                            Store users&rsquo; reviews in monthly buckets

                            ```javascript
                            // db.reviews (one document per user per month)
                            {   _id: "bob-201210",
                                reviews: [
                                    {   _id: ObjectId("…"),
                                        rating: 5,
                                        text: "This book is excellent!",
                                        created_at: ISODate("2012-10-10T21:14:07.096Z")
                                    },
                                    {   _id: ObjectId("…"),
                                        rating: 2,
                                        text: "I didn't really enjoy this book.",
                                        created_at: ISODate("2012-10-11T20:12:50.594Z")
                                    }
                                ]
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #2: Solution

                            Adding a new review to the appropriate bucket

                            ```javascript
                            myReview = {
                                _id: ObjectId("…"),
                                rating: 3,
                                text: "An average read.",
                                created_at: ISODate("2012-10-13T12:26:11.502Z")
                            };

                            > db.reviews.update(
                                  { _id: "bob-201210" },
                                  { $push: { reviews: myReview }}
                            );
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #2: Solution

                            Display the 10 most recent reviews by a user

                            ```javascript
                            cursor = db.reviews.find(
                                { _id: /^bob-/ },
                                { reviews: { $slice: -10 }}
                            ).sort({ _id: -1 }).batchSize(5);

                            num = 0;

                            while (cursor.hasNext() &amp;&amp; num &lt; 10) {
                                doc = cursor.next();

                                for (var i = 0; i &lt; doc.reviews.length &amp;&amp; num &lt; 10; ++i, ++num) {
                                    printjson(doc.reviews[i]);
                                }
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #2: Solution

                            Deleting a review

                            ```javascript
                            cursor = db.reviews.update(
                                { _id: "bob-201210" },
                                { $pull: { reviews: { _id: ObjectId("…") }}}
                            );
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Iterative Modifications

                            Schema design is evolutionary
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Allow users to browse by book subject

                            ```javascript
                            > db.subjects.findOne()
                            {
                                _id: 1,
                                name: "American Literature",
                                sub_category: {
                                     name: "1920s",
                                     sub_category: { name: "Jazz Age" }
                               }
                            }
                            ```

                            * How can you search this collection?
                            * Be aware of document size limitations
                            * Benefit from hierarchy being in same document
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Tree Structures

                            ```javascript
                            > db.subjects.find()
                            {   _id: "American Literature" }

                            {   _id : "1920s",
                                ancestors: ["American Literature"],
                                parent: "American Literature"
                            }

                            {   _id: "Jazz Age",
                                ancestors: ["American Literature", "1920s"],
                                parent: "1920s"
                            }

                            {   _id: "Jazz Age in New York",
                                ancestors: ["American Literature", "1920s", "Jazz Age"],
                                parent: "Jazz Age"
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Tree Structures

                            Find sub-categories of a given subject

                            ```javascript
                            > db.subjects.find({ ancestors: "1920s" })
                            {
                                _id: "Jazz Age",
                                ancestors: ["American Literature", "1920s"],
                                parent: "1920s"
                            }

                            {
                                _id: "Jazz Age in New York",
                                ancestors: ["American Literature", "1920s", "Jazz Age"],
                                parent: "Jazz Age"
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #3

                            * Allow users to borrow library books
                                * User sends a loan request
                                * Library approves or not
                                * Requests time out after seven days
                            * Approval process is asynchronous
                            * Requests may be prioritized
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #3: Solution

                            * Need to maintain order and state
                            * Ensure that updates are atomic

                            ```javascript
                            // Create a new loan request
                            db.loans.insert({
                                _id: { borrower: "bob", book: ObjectId("…") },
                                pending: false,
                                approved: false,
                                priority: 1,
                            });

                            // Find the highest priority request and mark as pending approval
                            request = db.loans.findAndModify({
                                query: { pending: false },
                                sort: { priority: -1 },
                                update: { $set: { pending: true, started: new ISODate() }},
                                new: true
                            });
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #3: Solution

                            * Updated and added fields
                            * Modified document was returned

                            ```javascript
                            {
                                _id: { borrower: "bob", book: ObjectId("…") },
                                pending: true,
                                approved: false,
                                priority: 1,
                                started: ISODate("2012-10-11T22:09:42.542Z")
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #3: Solution

                            ```javascript
                            // Library approves the loan request
                            db.loans.update(
                                { _id: { borrower: "bob", book: ObjectId("…") }},
                                { $set: { pending: false, approved: true }}
                            );
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #3: Solution

                            ```javascript
                            // Request times out after seven days
                            limit = new Date();
                            limit.setDate(limit.getDate() - 7);

                            db.loans.update(
                                { pending: true, started: { $lt: limit }},
                                { $set: { pending: false, approved: false }}
                            );
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #4

                            Allow users to recommend books

                            * Users can recommend each book only once
                            * Display a book&rsquo;s current recommendations
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #4: Solution

                            ```javascript
                            // db.recommendations (one document per user per book)
                            db.recommendations.insert({
                                book: ObjectId("…"),
                                user: ObjectId("…")
                            });

                            // Unique index ensures users can't recommend twice
                            db.recommendations.ensureIndex(
                                { book: 1, user: 1 },
                                { unique: true }
                            );

                            // Count the number of recommendations for a book
                            db.recommendations.count({ book: ObjectId("…") });
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #4: Solution

                            * Indexes in MongoDB are not counting
                            * Counts are computed via index scans
                            * Denormalize totals on books

                            ```javascript
                            db.books.update(
                                { _id: ObjectId("…") },
                                { $inc: { recommendations: 1 }}
                            });
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h1>Common Design Patterns</h1>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # One-to-one Relationship

                            Let&rsquo;s pretend that authors only write one book.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Linking

                            Either side, or both, can track the relationship.

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: 1,
                                // Other fields follow…
                            }

                            > db.authors.findOne({ _id: 1 })
                            {
                                _id: 1,
                                first_name: "F. Scott",
                                last_name: "Fitzgerald"
                                book: 1,
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Embedded Object

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: {
                                    first_name: "F. Scott",
                                    last_name: "Fitzgerald"
                                }
                                // Other fields follow…
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # One-to-many Relationship

                            In reality, authors may write multiple books.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of IDs

                            The "one" side tracks the relationship.

                            ```javascript
                            > db.authors.findOne()
                            {
                                _id: 1,
                                first_name: "F. Scott",
                                last_name: "Fitzgerald",
                                books: [1, 3, 20]
                            }
                            ```

                            * Flexible and space-efficient
                            * Additional query needed for non-ID lookups
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Single Field with ID

                            The "many" side tracks the relationship.

                            ```javascript
                            > db.books.find({ author: 1 })
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                slug: "9781857150193-the-great-gatsby",
                                author: 1,
                                // Other fields follow…
                            }

                            {
                                _id: 3,
                                title: "This Side of Paradise",
                                slug: "9780679447238-this-side-of-paradise",
                                author: 1,
                                // Other fields follow…
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of Objects

                            ```javascript
                            > db.authors.findOne()
                            {
                                _id: 1,
                                first_name: "F. Scott",
                                last_name: "Fitzgerald",
                                books: [
                                    { _id: 1, title: "The Great Gatsby" },
                                    { _id: 3, title: "This Side of Paradise" }
                                ]
                                // Other fields follow…
                            }
                            ```

                            Use `$slice` operator to return a subset of books
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Many-to-many Relationship

                            Some books may also have co-authors.
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of IDs on Both Sides

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                authors: [1, 5]
                                // Other fields follow…
                            }
                            ```

                            ```javascript
                            > db.authors.findOne()
                            {
                                _id: 1,
                                first_name: "F. Scott",
                                last_name: "Fitzgerald",
                                books: [1, 3, 20]
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of IDs on Both Sides

                            Query for all books by a given author

                            ```javascript
                            db.books.find({ authors: 1 });
                            ```

                            Query for all authors of a given book

                            ```javascript
                            db.authors.find({ books: 1 });
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of IDs on One Side

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 1,
                                title: "The Great Gatsby",
                                authors: [1, 5]
                                // Other fields follow…
                            }
                            ```

                            ```javascript
                            > db.authors.find({ _id: { $in: [1, 5] }})
                            {
                                _id: 1,
                                first_name: "F. Scott",
                                last_name: "Fitzgerald"
                            }

                            {
                                _id: 5,
                                first_name: "Unknown",
                                last_name: "Co-author"
                            }
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Array of IDs on One Side

                            Query for all books by a given author

                            ```javascript
                            db.books.find({ authors: 1 });
                            ```

                            Query for all authors of a given book

                            ```javascript
                            book = db.books.findOne(
                                { title: "The Great Gatsby" },
                                { authors: 1 }
                            );

                            db.authors.find({ _id: { $in: book.authors }});
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #5

                            * Tracking time series data
                                * Graph recommendations per unit of time
                                * Count by: day, hour, minute
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #5: Solution A

                            ```javascript
                            // db.rec_ts (time series buckets, hour and minute sub-docs)
                            db.rec_ts.insert({
                                book: ObjectId("…"),
                                day: ISODate("2012-10-11T00:00:00.000Z")
                                total: 0,
                                hour:   { "0": 0, "1": 0, /* … */ "23": 0 },
                                minute: { "0": 0, "1": 0, /* … */ "1439": 0 }
                            });

                            // Record a recommendation created one minute before midnight
                            db.rec_ts.update(
                                { book: ObjectId("…"), day: ISODate("2012-10-11T00:00:00.000Z") },
                                { $inc: { total: 1, "hour.23": 1, "minute.1439": 1 }}
                            });
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## BSON Storage

                            * Sequence of key/value pairs
                            * Not a hash map
                            * Optimized to scan quickly

                            <br>
                            <div class="node-3">
                                <div class="node">
                                    <span class="label">minute</span>
                                    <small><code>[0] [1] … [1439]</code></small>
                                </div>
                            </div>

                            What is the cost of updating the minute before midnight?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## BSON Storage

                            We can skip sub-documents

                            <br>
                            <div class="node-3">
                                <div class="node">
                                    <span class="label">hour<sub>0</sub></span>
                                    <small><code>[0] [1] … [59]</code></small>
                                </div>
                                <div class="arrow">…</div>
                                <div class="node">
                                    <span class="label">hour<sub>23</sub></span>
                                    <small><code>[1380] … [1439]</code></small>
                                </div>
                            </div>

                            How could this change the schema?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ### Exercise #5: Solution B

                            ```javascript
                            // db.rec_ts (time series buckets, each hour a sub-doc)
                            db.rec_ts.insert({
                                book: ObjectId("…"),
                                day: ISODate("2012-10-11T00:00:00.000Z")
                                total: 148,
                                hour: {
                                    "0": { total: 7, "0": 0, /* … */ "59": 2 },
                                    "1": { total: 3, "60": 1, /* … */ "119": 0 },
                                    // Other hours…
                                    "23": { total: 12, "1380": 0, /* … */ "1439": 3 }
                                }
                            });

                            // Record a recommendation created one minute before midnight
                            db.rec_ts.update(
                                { book: ObjectId("…"), day: ISODate("2012-10-11T00:00:00.000Z") },
                                { $inc: { total: 1, "hour.23.total": 1, "hour.23.1439": 1 }}
                            });
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Single-collection Inheritance

                            Take advantage of MongoDB&rsquo;s features

                            * Documents need not all have the same fields
                            * [Sparsely index](http://www.mongodb.org/display/DOCS/Indexes#Indexes-sparse%3Atrue) only present fields
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Schema Flexibility

                            ```javascript
                            > db.books.findOne()
                            {
                                _id: 47,
                                title: "The Wizard Chase",
                                type: "series",
                                series_title: "The Wizard's Trilogy",
                                volume: 2
                                // Other fields follow…
                            }
                            ```

                            Find all books that are part of a series

                            ```javascript
                            db.books.find({ type: "series" });

                            db.books.find({ series_title: { $exists: true }});

                            db.books.find({ volume: { $gt: 0 }});
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Index Only Present Fields

                            Documents without these fields will not be indexed.

                            ```javascript
                            db.books.ensureIndex({ series_title: 1 }, { sparse: true });

                            db.books.ensureIndex({ volume: 1 }, { sparse: true });
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #6

                            Users can recommend at most 10 books
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #6: Solution

                            ```javascript
                            // db.user_recs (track user's remaining and given recommendations)
                            db.user_recs.insert({
                                _id: "bob",
                                remaining: 8,
                                books: [3, 10]
                            });

                            // Record a recommendation if possible
                            db.user_recs.update(
                                { _id: "bob", remaining: { $gt: 0 }, books: { $ne: 4 }},
                                { $inc: { remaining: -1 }, $push: { books: 4 }}
                            });
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #6: Solution

                            * One less unassigned recommendation remaining
                            * Newly-recommended book is now linked

                            ```javascript
                            > db.user_recs.findOne()
                            {
                                _id: "bob",
                                remaining: 7,
                                books: [3, 10, 4]
                            }
                            ```
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #7

                            * Statistic buckets
                                * Each book has a listing page in our application
                                * Record referring website domains for each book
                                * Count each domain independently
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #7: Solution A

                            ```javascript
                            > db.book_refs.findOne()
                            {   book: 1,
                                referrers: [
                                    { domain: "google.com", count: 4 },
                                    { domain: "yahoo.com", count: 1 }
                                ]
                            }
                            ```

                            ```javascriptdb.book_refs.update(
                                { book: 1, "referrers.domain": "google.com" },
                                { $inc: { "referrers.$.count": 1 }}
                            );
                            ```
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #7: Solution A

                            Update the position of the first matched element.

                            ```javascript
                            db.book_refs.update(
                                { book: 1, "referrers.domain": "google.com" },
                                { $inc: { "referrers.$.count": 1 }}
                            );
                            ```

                            ```javascript
                            > db.book_refs.findOne()
                            {   book: 1,
                                referrers: [
                                    { domain: "google.com", count: 5 },
                                    { domain: "yahoo.com", count: 1 }
                                ]
                            }
                            ```

                            What if a new referring website is used?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #7: Solution B

                            ```javascript
                            > db.book_refs.findOne()
                            {   book: 1,
                                referrers: {
                                    "google_com": 5,
                                    "yahoo_com": 1
                                }
                            }
                            ```

                            ```javascriptdb.book_refs.update(
                                { book: 1 },
                                { $inc: { "referrers.bing_com": 1 }},
                                true
                            );
                            ```

                            * Replace dots with underscores for key names
                            * Increment to add a new referring website
                            * Upsert in case this is the book&rsquo;s first referrer
                        </script>
                    </section>
                </section>

                <section>
                    <section>
                        <h1>Sharding</h1>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding

                            * Ad-hoc partitioning
                            * Consistent hashing
                                * Amazon DynamoDB
                            * Range based partitioning
                                * Google BigTable
                                * Yahoo! PNUTS
                                * MongoDB
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding in MongoDB

                            * Automated management
                            * Range based partitioning
                            * Convert to sharded system with no downtime
                            * Fully consistent
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding a Collection

                            ```javascript
                            db.runCommand({ addshard : "shard1.example.com" });

                            db.runCommand({ enableSharding: "library" });

                            db.runCommand({
                                shardCollection: "library.books",
                                key: { _id : 1}
                            });
                            ```

                            * Keys range from &minus;&infin; to +&infin;
                            * Ranges are stored as chunks
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding Data by Chunks

                            ```javascript
                            db.books.save({ _id: 35, title: "Call of the Wild" });
                            db.books.save({ _id: 40, title: "Tropic of Cancer" });
                            db.books.save({ _id: 45, title: "The Jungle" });
                            db.books.save({ _id: 50, title: "Of Mice and Men" });
                            ```

                            <div class="node-3">
                                <div class="node">
                                    <ul>
                                        <li><code>(&minus;&infin;, +&infin;)</code></li>
                                    </ul>
                                </div>
                                <div class="arrow">&rarr;</div>
                                <div class="node">
                                    <ul>
                                        <li><code>(&minus;&infin;, 40)</code></li>
                                        <li><code>[40, +&infin;)</code></li>
                                    </ul>
                                </div>
                                <div class="arrow">&rarr;</div>
                                <div class="node">
                                    <ul>
                                        <li><code>(&minus;&infin;, 40)</code></li>
                                        <li><code>[40, 50)</code></li>
                                        <li><code>[50, +&infin;)</code></li>
                                    </ul>
                                </div>
                            </div>

                            Ranges are split into chunks as data is inserted
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Adding New Shards

                            <div class="node-3">
                                <div class="node">
                                    <span class="label">shard<sub>1</sub></span>
                                    <ul>
                                        <li><code>(&minus;&infin;, 40)</code></li>
                                        <li><code>[40, 50)</code></li>
                                        <li><code>[50, 60)</code></li>
                                        <li><code>[60, +&infin;)</code></li>
                                    </ul>
                                </div>
                            </div>
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Adding New Shards

                            ```javascript
                            db.runCommand({ addshard : "shard2.example.com" });
                            ```

                            <div class="node-3">
                                <div class="node">
                                    <span class="label">shard<sub>1</sub></span>
                                    <ul>
                                        <li><code>(&minus;&infin;, 40)</code></li>
                                        <li>&nbsp;</li>
                                        <li><code>[50, 60)</code></li>
                                        <li>&nbsp;</li>
                                    </ul>
                                </div>
                                <div class="node">
                                    <span class="label">shard<sub>2</sub></span>
                                    <ul>
                                        <li>&nbsp;</li>
                                        <li><code>[40, 50)</code></li>
                                        <li>&nbsp;</li>
                                        <li><code>[60, +&infin;)</code></li>
                                    </ul>
                                </div>
                            </div>

                            Chunks are migrated to balance shards
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Adding New Shards

                            ```javascript
                            db.runCommand({ addshard : "shard3.example.com" });
                            ```

                            <div class="node-3">
                                <div class="node">
                                    <span class="label">shard<sub>1</sub></span>
                                    <ul>
                                        <li><code>(&minus;&infin;, 40)</code></li>
                                        <li>&nbsp;</li>
                                        <li>&nbsp;</li>
                                        <li>&nbsp;</li>
                                    </ul>
                                </div>
                                <div class="node">
                                    <span class="label">shard<sub>2</sub></span>
                                    <ul>
                                        <li>&nbsp;</li>
                                        <li><code>[40, 50)</code></li>
                                        <li>&nbsp;</li>
                                        <li><code>[60, +&infin;)</code></li>
                                    </ul>
                                </div>
                                <div class="node">
                                    <span class="label">shard<sub>3</sub></span>
                                    <ul>
                                        <li>&nbsp;</li>
                                        <li>&nbsp;</li>
                                        <li><code>[50, 60)</code></li>
                                        <li>&nbsp;</li>
                                    </ul>
                                </div>
                            </div>
                        </script>
                    </section>

                    <section>
                        <img src="img/sharding_cache-1.png" alt="sharding_cache-1.png">
                    </section>

                    <section>
                        <img src="img/sharding_cache-2.png" alt="sharding_cache-2.png">
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharding Components

                            * `mongos`
                            * Config servers
                            * Shards
                                * `mongod`
                                * Replica sets
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharded Writes

                            * Inserts
                                * Shard key required
                                * Routed
                            * Updates and removes
                                * Shard key optional
                                * May be routed or scattered
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Sharded Reads

                            * Queries
                                * By shard key: routed
                                * Without shard key: scatter/gather
                            * Sorted queries
                                * By shard key: routed in order
                                * Without shard key: distributed merge sort
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #8

                            Users can upload images for books

                            <br>
                            <div class="node-3">
                                <div class="node">
                                    <span class="label">images</span>
                                    <ul>
                                        <li><code>image_id: ???</code></li>
                                        <li><code>data: binary</code></li>
                                    </ul>
                                </div>
                            </div>
                            <br>

                            The collection will be sharded by `image_id`.

                            What should `image_id` be?
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            ## Exercise #8: Solutions

                            What&rsquo;s the best shard key for our use case?

                            * Auto-increment (ObjectId)
                            * MD5 of data
                            * Time (e.g. month) and MD5
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            <img src="img/shard_key-1.png" alt="shard_key-1.png">

                            Right-balanced Access
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            <img src="img/shard_key-2.png" alt="shard_key-2.png">

                            Random Access
                        </script>
                    </section>

                    <section data-markdown>
                        <script type="text/template">
                            <img src="img/shard_key-3.png" alt="shard_key-3.png">

                            Segmented Access
                        </script>
                    </section>
                </section>

                <section>
                    <section data-markdown>
                        <script type="text/template">
                            # Summary

                            * Schema design is different in MongoDB.
                            * Basic data design principles apply.
                            * It&rsquo;s about your application.
                            * It&rsquo;s about your data and how it&rsquo;s used.
                            * It&rsquo;s about the entire lifetime of your application.
                        </script>
                    </section>

                    <section data-markdown data-state="final">
                        <script type="text/template">
                            # Thanks!

                            ### Questions?
                        </script>
                    </section>
                </section>
            </div>
        </div>

        <script src="../vendor/reveal.js/lib/js/head.min.js"></script>
        <script src="../vendor/reveal.js/js/reveal.js"></script>
        <script src="../common/js/reveal.js"></script>
    </body>
</html>
